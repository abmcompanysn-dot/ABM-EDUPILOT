
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Espace Étudiant - ABM EduPilote</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/5HMmW3HK/logo-abm-edu-pilote.png">
    <!-- CORRECTION: Ajout de 'defer' pour garantir que les scripts sont chargés avant exécution -->
    <script src="html2canvas.min.js" defer></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root{ --bg:#f5f3ff; --muted:#6b7280; --card-gap:1.5rem; --radius:14px; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f0f7; /* Un fond plus doux */
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
        }
        h1, h2, h3 { font-family: 'Poppins', sans-serif; }

        /* Styles pour le modal */
        #modal-container.hidden { display: none; }
        .modal-content {
            transition: transform 0.3s ease-out;
            transform: translateY(20px);
        }
        #modal-container:not(.hidden) .modal-content {
            transform: translateY(0);
        }

        /* Styles pour les squelettes de chargement */
        .skeleton {
            background-color: #e2e8f0; /* bg-gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }
    </style>
    <script src="config.js"></script> <!-- NOUVEAU: Fichier de configuration centralisé -->
</head>
<body class="antialiased text-gray-800">

    <!-- HEADER -->
    <header class="bg-gradient-to-r from-[#1C2B5A] to-[#432284] shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between py-4">
                 <div class="flex items-center space-x-3">
                     <img src="https://i.postimg.cc/5HMmW3HK/logo-abm-edu-pilote.png" alt="Logo ABM EduPilote" class="w-10 h-10 bg-white p-1 rounded-md">
                     <div>
                         <a href="index.html" class="text-white font-semibold text-lg">ABM EduPilote</a>
                         <p class="text-xs text-violet-300 -mt-0.5">Espace Étudiant</p>
                     </div>
                 </div>
                 <!-- NOUVEAU: Menu Paramètres -->
                 <div class="relative">
                     <button onclick="toggleSettingsMenu()" class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition">
                         <i class="fas fa-cog"></i>
                     </button>
                     <div id="settings-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                         <a href="#" onclick="openModal('profile'); toggleSettingsMenu();" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Modifier mes infos</a>
                         <a href="#" onclick="studentLogout()" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Déconnexion</a>
                     </div>
                 </div>
            </div>
        </div>
    </header>

    <!-- NOUVELLE INTERFACE MOBILE -->
    <main class="w-full max-w-lg mx-auto p-4">
        <!-- NOUVELLE Carte QR Code type "Carte Bancaire" -->
        <div class="bg-gradient-to-br from-violet-600 to-indigo-700 text-white rounded-2xl shadow-2xl p-5 flex items-center gap-5 my-6">
            <!-- QR Code à gauche -->
            <div id="main-qr-code-container" class="p-2 bg-white rounded-lg flex-shrink-0">
                <div id="main-qr-code" class="w-20 h-20 skeleton"></div>
            </div>
            <!-- Infos à droite -->
            <div class="flex-grow text-left">
                <h1 class="text-xl font-bold truncate" id="student-dashboard-name">
                    <span class="skeleton inline-block h-7 w-40 bg-white/20"></span>
                </h1>
                <p class="text-xs text-violet-200 font-mono mt-1" id="student-dashboard-id">
                    <span class="skeleton inline-block h-4 w-24 bg-white/20"></span>
                </p>
                <button onclick="downloadQrCodeOnly()" class="mt-3 bg-white/20 hover:bg-white/30 text-white font-semibold py-1.5 px-3 rounded-md text-xs flex items-center gap-1.5">
                    <i class="fas fa-download"></i>
                    <span>QR Code</span>
                </button>
            </div>
        </div>

        <!-- Panneau d'actions -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mt-8">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Mon Espace</h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="openModal('schedule')" class="text-left p-4 bg-violet-50 hover:bg-violet-100 rounded-lg transition-all">
                    <i class="fas fa-calendar-alt text-2xl text-violet-500 mb-2"></i>
                    <p class="font-semibold">Emploi du Temps</p>
                </button>
                <button onclick="openModal('attendance')" class="text-left p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-all">
                    <i class="fas fa-check-circle text-2xl text-green-500 mb-2"></i>
                    <p class="font-semibold">Mon Historique</p>
                </button>
            </div>
        </div>
    </main>

    <!-- NOUVEAU: Conteneur Modal -->
    <div id="modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden p-4 flex items-end justify-center" onclick="closeModal()">
        <div class="modal-content bg-white w-full max-w-lg rounded-t-2xl shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold"></h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto">
                <!-- Le contenu sera injecté ici -->
            </div>
        </div>
    </div>

    <!-- TEMPLATES POUR LES MODALES -->
    <template id="schedule-template">
        <div id="student-schedule-container" class="space-y-4">
            <!-- Squelette pour l'emploi du temps -->
            <div class="skeleton h-20 w-full"></div>
            <div class="skeleton h-20 w-full"></div>
        </div>
    </template>

    <template id="attendance-template">
        <div id="student-attendance-history" class="space-y-4">
            <!-- Squelette pour l'historique -->
            <div class="skeleton h-16 w-full"></div>
            <div class="skeleton h-16 w-full"></div>
        </div>
    </template>

    <template id="profile-template">
        <form id="studentUpdateForm" class="space-y-4">
            <div>
                <label for="student-info-name" class="block text-sm font-medium text-gray-700">Nom Complet</label>
                <input type="text" id="student-info-name" required class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md">
            </div>
            <div>
                <label for="student-info-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="student-info-email" required class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md">
            </div>
            <div>
                <label for="student-info-telephone" class="block text-sm font-medium text-gray-700">Téléphone (Format international)</label>
                <input type="tel" id="student-info-telephone" class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md" placeholder="Ex: +221771234567" pattern="\+[0-9]+" title="Veuillez entrer le numéro au format international, ex: +221...">
            </div>
            <button type="submit" class="submitBtn w-full bg-violet-600 hover:bg-violet-700 text-white py-2 rounded-md font-semibold flex items-center justify-center gap-3">
                <span class="btnText">Mettre à jour</span>
                <span class="btnSpinner hidden">Sauvegarde...</span>
            </button>
        </form>
        <div class="messageArea mt-3 text-center" aria-live="polite"></div>
    </template>

    <!-- NOUVEAU: Conteneur invisible pour générer la carte étudiant -->
    <div id="student-card-generator" class="w-[320px] h-[500px] fixed -left-[9999px] top-0 bg-white shadow-2xl flex flex-col" style="font-family: 'Inter', sans-serif; box-sizing: border-box;">
        <!-- En-tête coloré -->
        <div class="bg-gradient-to-r from-[#1C2B5A] to-[#432284] p-5 text-white text-center">
            <img src="https://i.postimg.cc/5HMmW3HK/logo-abm-edu-pilote.png" class="w-12 h-12 mx-auto mb-2" alt="Logo">
            <h3 id="card-university-name" class="font-bold text-lg"></h3>
        </div>
        <!-- Corps de la carte -->
        <div class="p-6 flex flex-col items-center text-center flex-grow">
            <!-- Placeholder pour la photo -->
            <div class="w-32 h-32 bg-gray-200 rounded-full flex items-center justify-center border-4 border-violet-100 mb-4">
                <i class="fas fa-user text-5xl text-gray-400"></i>
            </div>
            <!-- Informations -->
            <p id="card-student-name" class="text-2xl font-bold text-gray-800"></p>
            <!-- CORRECTION: Affichage de la filière et de l'université à la place de l'ID -->
            <p id="card-university-filiere" class="text-base text-gray-600 mt-1"></p> 
            <!-- QR Code -->
            <div id="card-qr-code" class="w-40 h-40 mt-auto p-1.5 bg-white border rounded-lg"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // --- AUTHENTIFICATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const studentSessionId = sessionStorage.getItem(STUDENT_SESSION_KEY);
            if (studentSessionId) {
                loadStudentDashboard(studentSessionId);
                // NOUVEAU: Réactivation du rafraîchissement automatique en arrière-plan
                // setInterval(() => {
                //     console.log('Refreshing student data in background...');
                //     loadStudentDashboard(studentSessionId, false); 
                // }, 90000); // Désactivé pour l'instant pour éviter les appels inutiles pendant le dev
            } else {
                window.location.href = 'index.html'; 
            }
        });

        // NOUVEAU: Gère l'ouverture/fermeture du menu des paramètres
        function toggleSettingsMenu() {
            document.getElementById('settings-menu').classList.toggle('hidden');
        }
        // Fermer le menu si on clique ailleurs
        window.addEventListener('click', function(e) {
            const settingsMenu = document.getElementById('settings-menu');
            const settingsButton = document.querySelector('.relative > button');
            if (!settingsMenu.classList.contains('hidden') && !settingsButton.contains(e.target) && !settingsMenu.contains(e.target)) {
                settingsMenu.classList.add('hidden');
            }
        });

        // --- Fonctions pour l'Espace Étudiant ---
        function studentLogout() 
        {
            sessionStorage.removeItem(STUDENT_SESSION_KEY);
            window.location.href = 'index.html';
        }

        async function loadStudentDashboard(studentId) {
            loadStudentInfo(studentId);
            // NOUVEAU: Charger le QR code principal
            renderMainQrCode(studentId);
            // Les autres données (historique, planning) seront chargées à la demande
        }

        async function loadStudentInfo(studentId) {
            try {
                const result = await callApi('getStudentData', { studentId });
                const student = result.data;
                document.getElementById('student-dashboard-name').textContent = student.name || 'Étudiant';
                document.getElementById('student-dashboard-id').textContent = studentId;
                
                // Pré-remplir le formulaire de mise à jour (qui est dans un template)
                document.getElementById('student-info-name').value = student.name || '';
                document.getElementById('student-info-email').value = student.email || '';
                document.getElementById('student-info-telephone').value = student.telephone || ''; // NOUVEAU
                document.getElementById('studentUpdateForm').onsubmit = (e) => handleUpdateStudentInfo(e, studentId);
            } catch (error) {
                displayMessageInForm(form, `Erreur: Impossible de charger vos informations. ${error.message}`, 'error');
            }
        }

        async function handleUpdateStudentInfo(e, studentId) {
            e.preventDefault();
            const form = e.target;
            const data = {
                studentId: studentId,
                name: form.querySelector('#student-info-name').value,
                email: form.querySelector('#student-info-email').value,
                telephone: form.querySelector('#student-info-telephone').value // NOUVEAU
            };
            setLoading(true, form);
            try {
                const result = await callApi('updateStudentInfo', data);
                displayMessageInForm(form, result.message, 'success');
                // Recharger les informations pour s'assurer que tout est à jour
                loadStudentDashboard(studentId); // Recharger tout le dashboard
            } catch (error) {
                displayMessageInForm(form, error.message, 'error');
            } finally {
                setLoading(false, form);
            }
        }

        // NOUVEAU: Affiche le QR code principal
        function renderMainQrCode(studentId) {
            const qrContainer = document.getElementById('main-qr-code');
            const qrData = `ABM-ETU-ID:${studentId}`; // CORRECTION: Taille du QR code réduite pour la nouvelle carte
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(qrData)}&bgcolor=ffffff&color=000000&qzone=1`;
            qrContainer.innerHTML = `<img src="${qrApiUrl}" alt="QR Code de l'étudiant" class="w-full h-full">`;
            qrContainer.classList.remove('skeleton');
        }

        // NOUVEAU: Télécharge uniquement le QR code au format PNG
        async function downloadQrCodeOnly() {
            try {
                const qrCodeContainer = document.getElementById('main-qr-code');
                const qrImg = qrCodeContainer ? qrCodeContainer.querySelector('img') : null;
                if (!qrImg || !qrImg.src) {
                    throw new Error("Le QR Code n'est pas encore affiché. Veuillez patienter.");
                }

                // Pour éviter les problèmes de CORS, on fetch l'image et on la convertit en blob
                const response = await fetch(qrImg.src);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `mon-qrcode-abm.png`;
                link.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert(`Erreur lors du téléchargement du QR Code : ${error.message}`);
            }
        }

        // NOUVEAU: Logique des modales
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        async function openModal(type) {
            const studentId = sessionStorage.getItem(STUDENT_SESSION_KEY);
            if (!studentId) return;

            modalContainer.classList.remove('hidden');
            let templateId, title;

            switch(type) {
                case 'schedule':
                    templateId = 'schedule-template';
                    title = 'Mon Emploi du Temps';
                    break;
                case 'attendance':
                    templateId = 'attendance-template';
                    title = 'Historique de mes Présences';
                    break;
                case 'profile':
                    templateId = 'profile-template';
                    title = 'Modifier mes Informations';
                    break;
                default:
                    return;
            }

            modalTitle.textContent = title;
            const template = document.getElementById(templateId);
            modalBody.innerHTML = '';
            modalBody.appendChild(template.content.cloneNode(true));

            // Charger les données spécifiques
            if (type === 'schedule') {
                await loadStudentSchedule(studentId);
            } else if (type === 'attendance') {
                await loadStudentAttendance(studentId);
            } else if (type === 'profile') {
                // Les données sont déjà pré-chargées, on attache juste le handler
                document.getElementById('studentUpdateForm').onsubmit = (e) => handleUpdateStudentInfo(e, studentId);
            }
        }

        function closeModal() {
            modalContainer.classList.add('hidden');
            modalBody.innerHTML = ''; // Vider le contenu
        }

        async function loadStudentAttendance(studentId) {
            const container = document.getElementById('student-attendance-history');
            try {
                const result = await callApi('getStudentAttendanceHistory', { studentId });
                const history = result.data;
                if (!history || history.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Aucun pointage enregistré.</p>';
                    return;
                }
                const timeline = document.createElement('div');
                timeline.className = 'space-y-4';
                timeline.innerHTML = history.map(item => `
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0 text-green-600">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">${item.MODULE}</p>
                            <p class="text-sm text-gray-500">${new Date(item.TIMESTAMP).toLocaleString('fr-FR', { dateStyle: 'long', timeStyle: 'short' })}</p>
                        </div>
                    </div>
                `).join('');
                container.innerHTML = '';
                container.appendChild(timeline);
            } catch (error) {
                container.innerHTML = `<p class="text-red-500">Erreur: ${error.message}</p>`;
            }
        }

        // NOUVEAU: Charge et affiche l'emploi du temps de l'étudiant
        async function loadStudentSchedule(studentId) {
            const container = document.getElementById('student-schedule-container');
            try {
                const result = await callApi('getStudentSchedule', { studentId });
                const courses = result.data;

                if (!courses || courses.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Aucun emploi du temps planifié pour votre classe.</p>';
                    return;
                }

                const scheduleHtml = courses.map(course => {
                    const statusColor = course.STATUT === 'Confirmé' ? 'bg-green-100 text-green-800' : (course.STATUT === 'Annulé' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800');
                    const statusIcon = course.STATUT === 'Confirmé' ? '✅' : (course.STATUT === 'Annulé' ? '❌' : '⏳');
                    return `
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 mb-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-gray-800">${course.MODULE}</p>
                                    <p class="text-sm text-gray-500">${new Date(course.DATE_COURS).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                                    <p class="text-sm text-gray-500">${new Date(course.HEURE_DEBUT).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${new Date(course.HEURE_FIN).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                </div>
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${statusIcon} ${course.STATUT}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div class="space-y-4">${scheduleHtml}</div>`;

            } catch (error) {
                container.innerHTML = `<p class="text-red-500">Erreur: ${error.message}</p>`;
            }
        }

        // --- FONCTIONS UTILITAIRES ---
        async function callApi(action, data = {}) {
            if (!WEB_APP_URL) throw new Error('URL de l\'API non configurée.');
            const response = await fetch(WEB_APP_URL, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action, data })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Erreur inconnue de l\'API.');
            return result;
        }

        function setLoading(isLoading, formElement) {
            const submitBtn = formElement ? formElement.querySelector('.submitBtn') : null;
            const btnText = formElement ? formElement.querySelector('.btnText') : null;
            const btnSpinner = formElement ? formElement.querySelector('.btnSpinner') : null;
            if (!submitBtn) return;
            submitBtn.disabled = isLoading;
            if (btnText) btnText.classList.toggle('hidden', isLoading);
            if (btnSpinner) btnSpinner.classList.toggle('hidden', !isLoading);
        }

        function displayMessageInForm(formElement, message, type) {
            let messageArea = formElement.nextElementSibling;
            if (!messageArea) return;
            const colorClass = type === 'success' ? 'text-green-600' : 'text-red-600';
            const bgColorClass = type === 'success' ? 'bg-green-50' : 'bg-red-50';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            
            messageArea.innerHTML = `
                <div class="flex items-start p-4 rounded-lg ${bgColorClass} ${colorClass}">
                    <i class="fas ${icon} mr-3 mt-1"></i>
                    <div><strong class="font-semibold">${type === 'success' ? 'Succès' : 'Erreur'}:</strong> ${message}</div>
                </div>
            `;
        }

    </script>

</body>
</html>
