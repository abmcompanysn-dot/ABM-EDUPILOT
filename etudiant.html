
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>Mon Espace - ABM EduPilote</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/5HMmW3HK/logo-abm-edu-pilote.png">
    <!-- CORRECTION: Le fichier html2canvas.min.js était manquant. Remplacement par un lien CDN. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBl5gI+YFkyWC4sLJhFdlQ9BlvRw==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- NOUVEAU: Ajout de la librairie pour le scanner QR -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root{ --bg:#f5f3ff; --muted:#6b7280; --card-gap:1.5rem; --radius:14px; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            /* NOUVEAU: Fond d'écran avec un voile pour la lisibilité */
            background-image: linear-gradient(rgba(240, 240, 247, 0.9), rgba(240, 240, 247, 0.9)), url('https://i.postimg.cc/Cx0pYgC2/photo-de-espcae-tudiant-africain.jpg');
            background-size: cover;
            background-attachment: fixed;
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
        }
        h1, h2, h3 { font-family: 'Poppins', sans-serif; }

        /* Styles pour le modal */
        #modal-container.hidden { display: none; }
        .modal-content {
            transition: transform 0.3s ease-out;
            transform: translateY(20px);
        }
        #modal-container:not(.hidden) .modal-content {
            transform: translateY(0);
        }

        /* Styles pour les squelettes de chargement */
        .skeleton {
            background-color: #e2e8f0; /* bg-gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }

        /* NOUVEAU: Styles pour la notation par étoiles */
        .star-rating {
            display: flex;
            flex-direction: row-reverse; /* Pour que le survol fonctionne de droite à gauche */
            justify-content: center;
            font-size: 2.5rem; /* Taille des étoiles */
            color: #d1d5db; /* gris-300 */
        }
        .star-rating label { cursor: pointer; transition: color 0.2s; padding: 0 0.25rem; }
        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #f59e0b; /* ambre-500 */
        }
    </style>
    <script src="config.js"></script> <!-- NOUVEAU: Fichier de configuration centralisé -->
</head>
<body class="antialiased text-gray-800">

    <!-- HEADER -->
    <header class="bg-gradient-to-r from-[#1C2B5A] to-[#432284] shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between py-4">
                 <div class="flex items-center space-x-3">
                     <img src="https://i.postimg.cc/5HMmW3HK/logo-abm-edu-pilote.png" alt="Logo ABM EduPilote" class="w-10 h-10 bg-white p-1 rounded-md">
                     <div>
                         <a href="index.html" class="text-white font-semibold text-lg">ABM EduPilote</a>
                         <p class="text-xs text-violet-300 -mt-0.5">Espace Étudiant</p>
                     </div>
                 </div>
                 <!-- NOUVEAU: Menu Paramètres -->
                 <div class="relative">
                     <button onclick="toggleSettingsMenu()" class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition">
                         <i class="fas fa-cog"></i>
                     </button>
                     <div id="settings-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50">
                         <a href="#" onclick="openModal('profile'); toggleSettingsMenu();" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Modifier mes infos</a>
                         <!-- Le bouton "Donner mon avis" a été déplacé dans le panneau d'actions principal -->
                         <a href="#" onclick="studentLogout()" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Déconnexion</a>
                     </div>
                 </div>
            </div>
        </div>
    </header>

    <!-- NOUVELLE INTERFACE MOBILE -->
    <main class="w-full max-w-lg mx-auto p-4">
        <!-- NOUVELLE Carte QR Code centrale avec le même fond que le header -->
        <div class="bg-gradient-to-r from-[#1C2B5A] to-[#432284] text-white rounded-2xl shadow-2xl p-6 text-center my-6">
            <h1 class="text-2xl font-bold" id="student-dashboard-name">
                <span class="skeleton inline-block h-8 w-48 bg-white/20"></span>
            </h1>
            <p class="text-sm text-violet-200 font-mono" id="student-dashboard-id">
                <span class="skeleton inline-block h-4 w-24 bg-white/20 mt-1"></span>
            </p>
            
            <!-- Conteneur pour le QR Code (plus grand et centré) -->
            <div id="main-qr-code-container" class="my-6 p-4 bg-white rounded-xl inline-block shadow-inner">
                <div id="main-qr-code" class="w-40 h-40 skeleton"></div>
            </div>

            <button onclick="downloadQrCodeOnly()" class="w-full bg-white/20 hover:bg-white/30 text-white font-semibold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                <i class="fas fa-download"></i>
                Télécharger mon QR Code
            </button>
        </div>

        <!-- Panneau d'actions -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mt-8">
            <h2 class="text-lg font-bold text-gray-900 mb-4">Mon Espace</h2>
            <div id="student-actions-grid" class="grid grid-cols-2 gap-4">
                <button onclick="openModal('schedule')" class="text-left p-4 bg-violet-50 hover:bg-violet-100 rounded-lg transition-all">
                    <i class="fas fa-calendar-alt text-2xl text-violet-500 mb-2"></i>
                    <p class="font-semibold">Emploi du Temps</p>
                </button>
                <button onclick="openModal('attendance')" class="text-left p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-all">
                    <i class="fas fa-history text-2xl text-green-500 mb-2"></i>
                    <p class="font-semibold">Mon Historique</p>
                </button>
                <!-- NOUVEAU: Bouton de notifications -->
                <button onclick="openModal('notifications')" class="relative text-left p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-all col-span-2">
                    <i class="fas fa-bell text-2xl text-blue-500 mb-2"></i>
                    <p class="font-semibold">Notifications</p>
                    <!-- NOUVEAU: Badge de notification -->
                    <span id="notification-badge" class="absolute top-2 right-2 w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center border-2 border-white hidden">
                        0
                    </span>
                </button>
                <!-- NOUVEAU: Bouton pour la carte RFID, caché par défaut -->
                <button id="rfid-card-btn" onclick="openModal('rfid-card')" class="hidden text-left p-4 bg-cyan-50 hover:bg-cyan-100 rounded-lg transition-all">
                    <i class="fas fa-id-card text-2xl text-cyan-500 mb-2"></i>
                    <p class="font-semibold">Ma Carte RFID</p>
                </button>
                <!-- NOUVEAU: Bouton pour donner son avis, déplacé ici -->
                <button onclick="openFeedbackModal('Etudiant')" class="text-left p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-all">
                    <i class="fas fa-comments text-2xl text-yellow-500 mb-2"></i>
                    <p class="font-semibold">Donner mon avis</p>
                </button>
            </div>
        </div>

        <!-- NOUVEAU: Liste déroulante des dernières présences -->
        <div class="bg-white rounded-2xl shadow-lg mt-8">
            <button id="presence-accordion-toggle" class="w-full flex justify-between items-center p-4 font-bold text-gray-900">
                <span>Mes Dernières Présences</span>
                <i class="fas fa-chevron-down transform transition-transform"></i>
            </button>
            <div id="presence-accordion-content" class="max-h-0 overflow-hidden transition-all duration-300 ease-in-out">
                <div id="recent-attendance-list" class="p-4 border-t border-gray-200">
                    <!-- Squelette pour la liste -->
                    <div class="skeleton h-12 w-full mb-2"></div>
                    <div class="skeleton h-12 w-full"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- NOUVEAU: Bouton flottant pour le scanner de l'étudiant -->
    <button id="scan-qr-btn-student" class="fixed bottom-6 right-6 bg-violet-600 hover:bg-violet-700 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center z-30 transition-transform hover:scale-110" aria-label="Scanner un QR Code de présence">
        <i class="fas fa-camera text-2xl"></i>
    </button>

    <!-- NOUVEAU: Conteneur pour le scanner QR Code de l'étudiant -->
    <div id="qr-scanner-container-student" class="fixed inset-0 bg-black/80 flex-col items-center justify-center p-4 hidden z-50">
        <p class="text-white text-lg mb-4 font-medium">Visez le QR Code du cours</p>
        <div id="qr-reader-student" class="w-full max-w-sm bg-gray-800 rounded-lg overflow-hidden border-4 border-violet-500 shadow-lg"></div>
        <div id="scanner-message-area" class="mt-4 text-center text-white"></div>
        <button id="close-scanner-btn-student" class="mt-6 bg-white/90 text-black font-bold py-2 px-8 rounded-full hover:bg-white transition-all">Annuler</button>
    </div>


    <!-- NOUVEAU: Conteneur Modal -->
    <div id="modal-container" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden p-4 flex items-end justify-center" onclick="closeModal()">
        <div class="modal-content bg-white w-full max-w-lg rounded-t-2xl shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold"></h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div id="modal-body" class="p-6 max-h-[70vh] overflow-y-auto">
                <!-- Le contenu sera injecté ici -->
            </div>
        </div>
    </div>

    <!-- TEMPLATES POUR LES MODALES -->
    <template id="schedule-template">
        <div id="student-schedule-container" class="space-y-4">
            <!-- Squelette pour l'emploi du temps -->
            <div class="skeleton h-20 w-full"></div>
            <div class="skeleton h-20 w-full"></div>
        </div>
    </template>

    <template id="attendance-template">
        <div id="student-attendance-history" class="space-y-4">
            <!-- Squelette pour l'historique -->
            <div class="skeleton h-16 w-full"></div>
            <div class="skeleton h-16 w-full"></div>
        </div>
    </template>

    <!-- NOUVEAU: Template pour les notifications -->
    <template id="notifications-template">
        <div id="student-notifications-container" class="space-y-4">
            <div class="skeleton h-20 w-full"></div>
        </div>
    </template>

    <template id="profile-template">
        <form id="studentUpdateForm" class="space-y-4">
            <div>
                <label for="student-info-name" class="block text-sm font-medium text-gray-700">Nom Complet</label>
                <input type="text" id="student-info-name" required class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md">
            </div>
            <div>
                <label for="student-info-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="student-info-email" required class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md">
            </div>
            <div>
                <label for="student-info-telephone" class="block text-sm font-medium text-gray-700">Téléphone (Format international)</label>
                <input type="tel" id="student-info-telephone" class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md" placeholder="Ex: +221771234567" pattern="\+[0-9]+" title="Veuillez entrer le numéro au format international, ex: +221...">
            </div>
            <button type="submit" class="submitBtn w-full bg-violet-600 hover:bg-violet-700 text-white py-2 px-4 rounded-md font-semibold flex items-center justify-center gap-3">
                <span class="btnText">Mettre à jour</span>
                <span class="btnSpinner hidden">Sauvegarde...</span>
            </button>
        </form>
        <div class="messageArea mt-3 text-center" aria-live="polite"></div>
    </template>

    <!-- NOUVEAU: Template pour la carte RFID -->
    <template id="rfid-card-template">
        <div class="bg-gray-100 p-6 rounded-lg border">
            <div class="text-center mb-4">
                <i class="fas fa-wifi text-blue-500 text-2xl transform -rotate-45"></i>
                <h4 class="font-bold text-lg mt-1">Carte d'Accès RFID</h4>
            </div>
            <div class="bg-white p-4 rounded-md space-y-3">
                <p><strong class="font-medium text-gray-500 w-24 inline-block">Nom:</strong> <span id="rfid-card-name" class="font-semibold text-gray-800"></span></p>
                <p><strong class="font-medium text-gray-500 w-24 inline-block">ID Étudiant:</strong> <span id="rfid-card-student-id" class="font-mono text-gray-800"></span></p>
                <hr class="my-2">
                <p><strong class="font-medium text-gray-500 w-24 inline-block">N° RFID:</strong> <span id="rfid-card-number" class="font-mono text-blue-600 font-bold text-lg"></span></p>
            </div>
        </div>
    </template>

    <!-- NOUVEAU: Conteneur invisible pour générer la carte étudiant -->
    <div id="student-card-generator" class="w-[320px] h-[500px] fixed -left-[9999px] top-0 bg-white shadow-2xl flex flex-col" style="font-family: 'Inter', sans-serif; box-sizing: border-box;">
        <!-- En-tête coloré -->
        !-- ... (contenu de la carte) ... -->
        <div class="bg-gradient-to-r from-[#1C2B5A] to-[#432284] p-5 text-white text-center">
            <img src="https://i.postimg.cc/5HMmW3HK/logo-abm-edu-pilote.png" class="w-12 h-12 mx-auto mb-2" alt="Logo" crossorigin="anonymous">
            <h3 id="card-university-name" class="font-bold text-lg"></h3>
        </div>
        <!-- Corps de la carte -->
        <div class="p-6 flex flex-col items-center text-center flex-grow">
            <!-- Placeholder pour la photo -->
            <div class="w-32 h-32 bg-gray-200 rounded-full flex items-center justify-center border-4 border-violet-100 mb-4">
                <i class="fas fa-user text-5xl text-gray-400"></i>
            </div>
            <!-- Informations -->
            <p id="card-student-name" class="text-2xl font-bold text-gray-800"></p>
            <!-- CORRECTION: Affichage de la filière et de l'université à la place de l'ID -->
            <p id="card-university-filiere" class="text-base text-gray-600 mt-1"></p> 
            <!-- QR Code -->
            <div id="card-qr-code" class="w-40 h-40 mt-auto p-1.5 bg-white border rounded-lg"></div>
        </div>
    </div>

    <!-- NOUVEAU: Conteneur invisible pour générer le rapport d'assiduité en PDF -->
    <div id="pdf-report-generator" class="fixed -left-[9999px] top-0 bg-white p-8 w-[800px]">
        <!-- Le contenu du rapport sera injecté ici avant la conversion en PDF -->
    </div>

    <script>
        // --- CONFIGURATION ---
        // NOUVEAU: Met à jour le badge de notification
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            if (!badge) return;

            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }


        // --- AUTHENTIFICATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const studentSessionId = sessionStorage.getItem(STUDENT_SESSION_KEY);
            if (studentSessionId) {
                loadStudentDashboard(studentSessionId);
                // NOUVEAU: Réactivation du rafraîchissement automatique en arrière-plan
                // setInterval(() => {
                //     console.log('Refreshing student data in background...');
                //     loadStudentDashboard(studentSessionId, false); 
                // }, 90000); // Désactivé pour l'instant pour éviter les appels inutiles pendant le dev
                // NOUVEAU: Initialiser le scanner de l'étudiant
                setupStudentScanner();
            } else {
                window.location.href = 'index.html'; 
            }
        });

        // NOUVEAU: Logique pour l'accordéon des présences
        document.getElementById('presence-accordion-toggle').addEventListener('click', function() {
            const content = document.getElementById('presence-accordion-content');
            const icon = this.querySelector('i');
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
            icon.classList.toggle('rotate-180');
        });

        // NOUVEAU: Gère l'ouverture/fermeture du menu des paramètres
        function toggleSettingsMenu() {
            document.getElementById('settings-menu').classList.toggle('hidden');
        }
        // Fermer le menu si on clique ailleurs
        window.addEventListener('click', function(e) {
            const settingsMenu = document.getElementById('settings-menu');
            const settingsButton = document.querySelector('.relative > button');
            if (!settingsMenu.classList.contains('hidden') && !settingsButton.contains(e.target) && !settingsMenu.contains(e.target)) {
                settingsMenu.classList.add('hidden');
            }
        });

        // --- Fonctions pour l'Espace Étudiant ---
        function studentLogout() 
        {
            // AMÉLIORATION PWA: Effacer la session ET l'identifiant mémorisé
            sessionStorage.removeItem(STUDENT_SESSION_KEY);
            localStorage.removeItem(STUDENT_SESSION_KEY); // Oublier l'utilisateur pour la prochaine visite
            window.location.href = 'index.html';
        }

        async function loadStudentDashboard(studentId) {
            loadStudentInfo(studentId);
            // NOUVEAU: Charger le QR code principal
            renderMainQrCode(studentId);
            // NOUVEAU: Charger la liste des présences récentes
            loadRecentAttendance(studentId);
            // NOUVEAU: Charger le statut des notifications
            loadNotificationStatus(studentId);
            // Les autres données (historique, planning) seront chargées à la demande
        }

        async function loadStudentInfo(studentId) {
            try {
                const result = await callApi('getStudentData', { studentId });
                const studentData = result.data;
                document.getElementById('student-dashboard-name').textContent = studentData.name || 'Étudiant';
                document.getElementById('student-dashboard-id').textContent = studentId;

                // NOUVEAU: Logique pour afficher le bouton RFID
                const rfidBtn = document.getElementById('rfid-card-btn');
                if (studentData.rfidId) {
                    rfidBtn.classList.remove('hidden');
                    // Ajuster la grille si le nombre d'éléments est impair
                    const grid = document.getElementById('student-actions-grid');
                    if (grid.children.length % 2 !== 0) {
                        rfidBtn.classList.add('col-span-2');
                    }
                }
            } catch (error) {
                alert(`Erreur critique: Impossible de charger vos informations. ${error.message}`);
            }
        }

        async function handleUpdateStudentInfo(e, studentId) {
            e.preventDefault();
            const form = e.target;
            const data = {
                studentId: studentId,
                name: form.querySelector('#student-info-name').value,
                email: form.querySelector('#student-info-email').value,
                telephone: form.querySelector('#student-info-telephone').value // NOUVEAU
            };
            setLoading(true, form);
            try {
                const result = await callApi('updateStudentInfo', data);
                displayMessageInForm(form, result.message, 'success');
                // Recharger les informations pour s'assurer que tout est à jour
                loadStudentDashboard(studentId); // Recharger tout le dashboard
            } catch (error) {
                displayMessageInForm(form, error.message, 'error');
            } finally {
                setLoading(false, form);
            }
        }

        // NOUVEAU: Affiche le QR code principal
        function renderMainQrCode(studentId) {
            const qrContainer = document.getElementById('main-qr-code');
            const qrData = `ABM-ETU-ID:${studentId}`;
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(qrData)}&bgcolor=ffffff&color=000000&qzone=1`;
            qrContainer.innerHTML = `<img src="${qrApiUrl}" alt="QR Code de l'étudiant" class="w-full h-full">`;
            qrContainer.classList.remove('skeleton');
        }

        // NOUVEAU: Télécharge uniquement le QR code au format PNG
        async function downloadQrCodeOnly() {
            try {
                const qrCodeContainer = document.getElementById('main-qr-code');
                const qrImg = qrCodeContainer ? qrCodeContainer.querySelector('img') : null;
                if (!qrImg || !qrImg.src) {
                    throw new Error("Le QR Code n'est pas encore affiché. Veuillez patienter.");
                }

                // Pour éviter les problèmes de CORS, on fetch l'image et on la convertit en blob
                const response = await fetch(qrImg.src);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `mon-qrcode-abm.png`;
                link.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert(`Erreur lors du téléchargement du QR Code : ${error.message}`);
            }
        }

        // NOUVEAU: Logique des modales
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');

        async function openModal(type) {
            const studentId = sessionStorage.getItem(STUDENT_SESSION_KEY);
            if (!studentId) return;

            modalContainer.classList.remove('hidden');
            let templateId, title;

            switch(type) {
                case 'schedule':
                    templateId = 'schedule-template';
                    title = 'Mon Emploi du Temps';
                    break;
                case 'attendance':
                    templateId = 'attendance-template';
                    title = 'Historique de mes Présences';
                    break;
                case 'profile':
                    templateId = 'profile-template';
                    title = 'Modifier mes Informations';
                    break;
                case 'message': // NOUVEAU: Pour les messages de confirmation
                    templateId = 'message-template';
                    title = 'Message';
                    break;
                case 'notifications': // NOUVEAU
                    templateId = 'notifications-template';
                    title = 'Mes Notifications';
                    break;
                case 'rfid-card': // NOUVEAU
                    templateId = 'rfid-card-template';
                    title = 'Ma Carte d\'Accès RFID';
                    break;
                default:
                    return;
            }

            modalTitle.textContent = title;
            const template = document.getElementById(templateId);
            modalBody.innerHTML = '';
            modalBody.appendChild(template.content.cloneNode(true));

            // Charger les données spécifiques
            if (type === 'schedule') {
                await loadStudentSchedule(studentId);
            } else if (type === 'attendance') {
                await loadStudentAttendance(studentId);
            } else if (type === 'profile') {
                // CORRECTION: On charge et pré-remplit le formulaire uniquement à l'ouverture de la modale.
                try {
                    const result = await callApi('getStudentData', { studentId });
                    const student = result.data;
                    document.getElementById('student-info-name').value = student.name || '';
                    document.getElementById('student-info-email').value = student.email || '';
                    document.getElementById('student-info-telephone').value = student.telephone || '';
                    document.getElementById('studentUpdateForm').onsubmit = (e) => handleUpdateStudentInfo(e, studentId);
                } catch (error) {
                    modalBody.innerHTML = `<p class="text-red-500">Erreur de chargement du profil: ${error.message}</p>`;
                }
            } else if (type === 'notifications') { // NOUVEAU
                await loadStudentNotifications(studentId);
            } else if (type === 'rfid-card') { // NOUVEAU
                try {
                    const result = await callApi('getStudentData', { studentId });
                    const student = result.data;
                    document.getElementById('rfid-card-name').textContent = student.name || '';
                    document.getElementById('rfid-card-student-id').textContent = studentId;
                    document.getElementById('rfid-card-number').textContent = student.rfidId || 'ERREUR';
                } catch (error) {
                    modalBody.innerHTML = `<p class="text-red-500">Erreur de chargement des informations: ${error.message}</p>`;
                }
            }
        }

        function closeModal() {
            modalContainer.classList.add('hidden');
            modalBody.innerHTML = ''; // Vider le contenu
        }

        // NOUVEAU: Charge et affiche les 5 dernières présences dans l'accordéon
        async function loadRecentAttendance(studentId) {
            const container = document.getElementById('recent-attendance-list');
            try {
                const result = await callApi('getStudentAttendanceHistory', { studentId });
                const history = result.data;
                if (!history || history.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Aucun pointage récent.</p>';
                    return;
                }
                // On ne prend que les 5 plus récents
                const recentHistory = history.slice(0, 5);
                const list = document.createElement('ul');
                list.className = 'space-y-3';
                list.innerHTML = recentHistory.map(item => `
                    <li class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0 text-green-600">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <p class="font-medium text-sm text-gray-800">${item.MODULE}</p>
                            <p class="text-xs text-gray-500">${new Date(item.TIMESTAMP).toLocaleString('fr-FR', { dateStyle: 'medium', timeStyle: 'short' })}</p>
                        </div>
                    </li>
                `).join('');
                container.innerHTML = '';
                container.appendChild(list);
            } catch (error) {
                container.innerHTML = `<p class="text-red-500 text-sm text-center py-4">Erreur: ${error.message}</p>`;
            }
        }

        async function loadStudentAttendance(studentId) {
            const container = document.getElementById('student-attendance-history');
            try {
                const result = await callApi('getStudentAttendanceHistory', { studentId });
                const history = result.data;
                if (!history || history.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Aucun pointage enregistré.</p>';
                    return;
                }
                const timeline = document.createElement('div');
                timeline.className = 'space-y-4';
                timeline.innerHTML = history.map(item => `
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0 text-green-600">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">${item.MODULE}</p>
                            <p class="text-sm text-gray-500">${new Date(item.TIMESTAMP).toLocaleString('fr-FR', { dateStyle: 'long', timeStyle: 'short' })}</p>
                        </div>
                    </div>
                `).join('');
                container.innerHTML = '';
                container.appendChild(timeline);
            } catch (error) {
                container.innerHTML = `<p class="text-red-500">Erreur: ${error.message}</p>`;
            }
        }

        // NOUVEAU: Charge et affiche l'emploi du temps de l'étudiant
        async function loadStudentSchedule(studentId) {
            const container = document.getElementById('student-schedule-container');
            try {
                const result = await callApi('getStudentSchedule', { studentId });
                const courses = result.data;

                if (!courses || courses.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">Aucun emploi du temps planifié pour votre classe.</p>';
                    return;
                }

                const scheduleHtml = courses.map(course => {
                    const statusColor = course.STATUT === 'Confirmé' ? 'bg-green-100 text-green-800' : (course.STATUT === 'Annulé' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800');
                    const statusIcon = course.STATUT === 'Confirmé' ? '✅' : (course.STATUT === 'Annulé' ? '❌' : '⏳');
                    return `
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 mb-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-gray-800">${course.MODULE}</p>
                                    <p class="text-sm text-gray-500">${new Date(course.DATE_COURS).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                                    <p class="text-sm text-gray-500">${new Date(course.HEURE_DEBUT).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${new Date(course.HEURE_FIN).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                </div>
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${statusIcon} ${course.STATUT}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div class="space-y-4">${scheduleHtml}</div>`;

            } catch (error) {
                container.innerHTML = `<p class="text-red-500">Erreur: ${error.message}</p>`;
            }
        }

        // NOUVEAU: Charge et affiche les notifications de l'étudiant
        async function loadStudentNotifications(studentId) {
            const container = document.getElementById('student-notifications-container');
            try {
                const result = await callApi('getUserNotifications', { studentId });

                // NOUVEAU: Cacher le badge après avoir ouvert les notifications
                updateNotificationBadge(0);

                const notifications = result.data;

                if (!notifications || notifications.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center">Aucune notification pour le moment.</p>';
                    return;
                }

                container.innerHTML = notifications.map(notif => {
                    const isGlobal = notif.ID_CLASSE_FK === 'ALL';
                    const author = notif.AUTEUR_INFO === 'Administration' ? 'Annonce Générale' : 'Message de votre classe';
                    const colorClass = isGlobal ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200';
                    return `
                        <div class="p-4 rounded-lg ${colorClass} border">
                            <div class="flex justify-between items-center mb-2">
                                <p class="font-bold text-gray-800">${notif.SUJET}</p>
                                ${isGlobal ? '<span class="text-xs font-semibold text-blue-600 bg-blue-100 px-2 py-1 rounded-full">GÉNÉRAL</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-600 whitespace-pre-wrap">${notif.CORPS}</p>
                            <p class="text-xs text-gray-400 text-right mt-3">${new Date(notif.TIMESTAMP).toLocaleString('fr-FR')}</p>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                container.innerHTML = `<p class="text-red-500">Erreur: ${error.message}</p>`;
            }
        }

        // NOUVEAU: Charge le statut des notifications pour mettre à jour le badge
        async function loadNotificationStatus(studentId) {
            try {
                const result = await callApi('getUserNotificationStatus', { studentId });
                const { unreadCount } = result.data;
                updateNotificationBadge(unreadCount);
            } catch (error) {
                console.error("Erreur de chargement du statut des notifications:", error);
                // On ne montre pas d'erreur à l'utilisateur pour cette fonction de fond
            }
        }


        // NOUVEAU: Logique du Scanner QR Code pour l'étudiant
        function setupStudentScanner() {
            const scanBtn = document.getElementById('scan-qr-btn-student');
            const scannerContainer = document.getElementById('qr-scanner-container-student');
            const closeBtn = document.getElementById('close-scanner-btn-student');
            const messageArea = document.getElementById('scanner-message-area');
            let html5QrCode = null;

            function onScanSuccess(decodedText) {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error("Erreur à l'arrêt du scanner.", err));
                }
                scannerContainer.classList.add('hidden');

                try {
                    // 1. Vérifier si c'est une URL de présence valide
                    const url = new URL(decodedText);
                    const params = url.searchParams;
                    if (params.get('page') !== 'attendance' || !params.has('classe')) {
                        throw new Error("Ce QR code n'est pas un code de présence valide.");
                    }

                    // 2. Récupérer l'ID de l'étudiant et la classe
                    const studentId = sessionStorage.getItem(STUDENT_SESSION_KEY);
                    const classe = params.get('classe');

                    if (!studentId) {
                        throw new Error("Votre session a expiré. Veuillez vous reconnecter.");
                    }

                    // 3. Appeler la nouvelle fonction pour pointer automatiquement
                    markAttendanceAutomatically(studentId, classe);

                } catch (e) {
                    alert("QR Code invalide ou non reconnu : " + e.message);
                }
            }

            scanBtn.addEventListener('click', () => {
                scannerContainer.classList.remove('hidden');
                scannerContainer.classList.add('flex');
                messageArea.innerHTML = ''; // Vider les messages précédents

                if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader-student");
                
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, () => {})
                .catch(err => {
                    alert("Impossible d'accéder à la caméra. Veuillez autoriser l'accès dans les paramètres de votre navigateur.");
                    scannerContainer.classList.add('hidden');
                });
            });

            closeBtn.addEventListener('click', () => {
                if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop();
                scannerContainer.classList.add('hidden');
            });
        }

        // NOUVEAU: Fonction pour enregistrer la présence sans formulaire
        async function markAttendanceAutomatically(studentId, classe) {
            // AMÉLIORATION: Utiliser une modale au lieu des alertes
            openModal('message'); // Ouvre une modale avec un spinner
            modalTitle.textContent = 'Pointage en cours...';
            modalBody.innerHTML = `<div class="text-center py-8"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-violet-500 mx-auto"></div><p class="mt-4 text-gray-600">Tentative de pointage pour la classe ${classe}...</p></div>`;

            try {
                const result = await callApi('recordAttendanceFromScan', { studentId, classe });
                // Afficher le message de succès dans la modale
                modalTitle.textContent = 'Succès !';
                modalBody.innerHTML = `<div class="text-center py-4">
                    <div class="text-5xl text-green-500 mb-4"><i class="fas fa-check-circle"></i></div>
                    <p class="text-lg text-gray-700">${result.message}</p>
                </div>`;
                loadRecentAttendance(studentId); // Rafraîchir la liste des présences
            } catch (error) {
                // Afficher le message d'erreur dans la modale
                modalTitle.textContent = 'Erreur';
                modalBody.innerHTML = `<div class="text-center py-4">
                    <div class="text-5xl text-red-500 mb-4"><i class="fas fa-times-circle"></i></div>
                    <p class="text-lg text-gray-700">${error.message}</p>
                </div>`;
            }
        }

        // NOUVEAU: Génère et télécharge le rapport d'assiduité de l'étudiant en PDF
        async function generateStudentAttendanceReport() {
            const studentId = sessionStorage.getItem(STUDENT_SESSION_KEY);
            if (!studentId) return;

            openModal('message');
            modalTitle.textContent = 'Génération du rapport...';
            modalBody.innerHTML = `<div class="text-center py-8"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-violet-500 mx-auto"></div><p class="mt-4 text-gray-600">Veuillez patienter...</p></div>`;

            try {
                // 1. Récupérer les données nécessaires (profil, stats, et rapport d'absence)
                const [profileResult, statsResult, reportResult] = await Promise.all([
                    callApi('getStudentData', { studentId }),
                    callApi('getStudentDashboardData', { studentId }), // Pour les stats globales
                    callApi('getStudentAbsenceReport', { studentId })
                ]);

                const profile = profileResult.data;
                const stats = statsResult.data.attendanceStats;
                const reportData = reportResult.data;

                // 2. Construire le HTML du rapport
                const reportContainer = document.getElementById('pdf-report-generator');
                const today = new Date().toLocaleDateString('fr-FR', { dateStyle: 'long' });

                let tableRows = reportData.map(item => {
                    const statusClass = item.status === 'Absent' ? 'text-red-600 font-bold' : 'text-green-600';
                    return `
                        <tr class="border-b">
                            <td class="py-2 px-4">${new Date(item.date).toLocaleDateString('fr-FR')}</td>
                            <td class="py-2 px-4">${item.module}</td>
                            <td class="py-2 px-4 ${statusClass}">${item.status}</td>
                        </tr>`;
                }).join('');

                reportContainer.innerHTML = `
                    <div class="font-sans p-4">
                        <h1 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Rapport d'Assiduité</h1>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <p><strong>Étudiant :</strong> ${profile.name}</p>
                                <p><strong>ID Étudiant :</strong> ${studentId}</p>
                            </div>
                            <div class="text-right">
                                <p><strong>Date du rapport :</strong> ${today}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-8 text-center">
                            <div class="bg-green-100 p-4 rounded-lg"><p class="text-lg font-bold text-green-800">${stats.participationRate}%</p><p class="text-sm text-green-700">Taux de Présence</p></div>
                            <div class="bg-red-100 p-4 rounded-lg"><p class="text-lg font-bold text-red-800">${stats.absenceRate}%</p><p class="text-sm text-red-700">Taux d'Absence</p></div>
                        </div>
                        <h2 class="text-xl font-bold text-gray-700 mb-2">Détail des Cours</h2>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100"><tr><th class="py-2 px-4">Date</th><th class="py-2 px-4">Module</th><th class="py-2 px-4">Statut</th></tr></thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>
                `;

                // 3. Générer le PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: 'a4' });
                await pdf.html(reportContainer, {
                    callback: function (doc) {
                        doc.save(`Rapport_Assiduite_${studentId}.pdf`);
                        closeModal();
                    },
                    x: 10, y: 10, width: 425, windowWidth: 800
                });

            } catch (error) {
                modalBody.innerHTML = `<div class="text-center py-4"><div class="text-5xl text-red-500 mb-4"><i class="fas fa-times-circle"></i></div><p class="text-lg text-gray-700">Erreur lors de la génération du rapport : ${error.message}</p></div>`;
            }
        }

        /**
         * NOUVEAU: Ouvre la modale pour donner un avis.
         * @param {string} userRole - Le rôle de l'utilisateur ('Admin', 'Responsable', 'Etudiant').
         */
        function openFeedbackModal(userRole) {
            const userId = sessionStorage.getItem(STUDENT_SESSION_KEY);

            const modalContentHtml = `
                <form id="feedback-form">
                    <div class="space-y-6">
                        <!-- NOUVEAU: Section pour la notation par étoiles -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-800 text-center">Quelle note globale donneriez-vous ?</h4>
                            <div class="star-rating my-4">
                                <input type="radio" id="star5" name="star_rating" value="5" class="hidden" required/><label for="star5" title="5 étoiles"><i class="fas fa-star"></i></label>
                                <input type="radio" id="star4" name="star_rating" value="4" class="hidden"/><label for="star4" title="4 étoiles"><i class="fas fa-star"></i></label>
                                <input type="radio" id="star3" name="star_rating" value="3" class="hidden"/><label for="star3" title="3 étoiles"><i class="fas fa-star"></i></label>
                                <input type="radio" id="star2" name="star_rating" value="2" class="hidden"/><label for="star2" title="2 étoiles"><i class="fas fa-star"></i></label>
                                <input type="radio" id="star1" name="star_rating" value="1" class="hidden"/><label for="star1" title="1 étoile"><i class="fas fa-star"></i></label>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-medium text-gray-800">Comment évaluez-vous l'application ?</h4>
                            <p class="text-sm text-gray-500">Cochez les cases qui correspondent à votre expérience.</p>
                            <div class="mt-4 space-y-3">
                                <label class="flex items-center"><input type="checkbox" name="rating" value="facile" class="h-4 w-4 text-violet-600 border-gray-300 rounded"> <span class="ml-3 text-gray-700">Facile à utiliser</span></label>
                                <label class="flex items-center"><input type="checkbox" name="rating" value="design-agreable" class="h-4 w-4 text-violet-600 border-gray-300 rounded"> <span class="ml-3 text-gray-700">Le design est agréable</span></label>
                                <label class="flex items-center"><input type="checkbox" name="rating" value="utile" class="h-4 w-4 text-violet-600 border-gray-300 rounded"> <span class="ml-3 text-gray-700">Les fonctionnalités sont très utiles</span></label>
                                <label class="flex items-center"><input type="checkbox" name="rating" value="rapide" class="h-4 w-4 text-violet-600 border-gray-300 rounded"> <span class="ml-3 text-gray-700">L'application est rapide</span></label>
                            </div>
                        </div>
                        <div>
                            <label for="feedback-corrections" class="block text-sm font-medium text-gray-700">Quels sont les points à corriger ou les bugs que vous avez rencontrés ?</label>
                            <textarea id="feedback-corrections" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md"></textarea>
                        </div>
                        <div>
                            <label for="feedback-ideas" class="block text-sm font-medium text-gray-700">Avez-vous des idées pour améliorer le projet ?</label>
                            <textarea id="feedback-ideas" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-200 rounded-md"></textarea>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Envoyer mon avis</button>
                    </div>
                </form>
            `;
            openModal('custom'); // Ouvre la modale générique
            document.getElementById('modal-title').textContent = 'Votre Avis Compte !';
            document.getElementById('modal-body').innerHTML = modalContentHtml;

            // Attacher le listener pour la soumission
            document.getElementById('feedback-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                setLoading(true, e.target);
                
                const ratings = {};
                document.querySelectorAll('input[name="rating"]').forEach(checkbox => {
                    ratings[checkbox.value] = checkbox.checked;
                });

                // NOUVEAU: Récupérer la note en étoiles
                const starRating = document.querySelector('input[name="star_rating"]:checked')?.value || '0';

                const data = {
                    userRole: userRole,
                    userId: userId,
                    ratings: ratings,
                    corrections: document.getElementById('feedback-corrections').value,
                    ideas: document.getElementById('feedback-ideas').value,
                    starRating: starRating // NOUVEAU: Ajouter la note au corps de la requête
                };

                try {
                    const result = await callApi('submitFeedback', data);
                    modalBody.innerHTML = `<div class="text-center py-4"><div class="text-5xl text-green-500 mb-4"><i class="fas fa-check-circle"></i></div><p class="text-lg text-gray-700">${result.message}</p></div>`;
                } catch (error) {
                    modalBody.innerHTML = `<div class="text-center py-4"><div class="text-5xl text-red-500 mb-4"><i class="fas fa-times-circle"></i></div><p class="text-lg text-gray-700">${error.message}</p></div>`;
                } finally {
                    setLoading(false, e.target);
                }
            });
        }

        // --- FONCTIONS UTILITAIRES ---
        async function callApi(action, data = {}) {
            if (!WEB_APP_URL) throw new Error('URL de l\'API non configurée.');
            const response = await fetch(WEB_APP_URL, {
                method: 'POST', mode: 'cors', redirect: 'follow', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action, data })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Erreur inconnue de l\'API.');
            return result;
        }

        function setLoading(isLoading, formElement) {
            const submitBtn = formElement ? formElement.querySelector('.submitBtn') : null;
            const btnText = formElement ? formElement.querySelector('.btnText') : null;
            const btnSpinner = formElement ? formElement.querySelector('.btnSpinner') : null;
            if (!submitBtn) return;
            submitBtn.disabled = isLoading;
            if (btnText) btnText.classList.toggle('hidden', isLoading);
            if (btnSpinner) btnSpinner.classList.toggle('hidden', !isLoading);
        }

        function displayMessageInForm(formElement, message, type) {
            let messageArea = formElement.nextElementSibling;
            if (!messageArea) return;
            const colorClass = type === 'success' ? 'text-green-600' : 'text-red-600';
            const bgColorClass = type === 'success' ? 'bg-green-50' : 'bg-red-50';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            
            messageArea.innerHTML = `
                <div class="flex items-start p-4 rounded-lg ${bgColorClass} ${colorClass}">
                    <i class="fas ${icon} mr-3 mt-1"></i>
                    <div><strong class="font-semibold">${type === 'success' ? 'Succès' : 'Erreur'}:</strong> ${message}</div>
                </div>
            `;
        }

    </script>

</body>
</html>
