<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABM EduPilote - Plateforme Universitaire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .action-card {
            transition: all 0.3s ease-in-out;
        }
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        #modal-content { max-height: 80vh; }
        .hidden-template { display: none; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Conteneur principal o√π les pages seront inject√©es -->
    <div id="app-container"></div>

    <!-- ================================================================== -->
    <!-- MOD√àLES HTML (TEMPLATES) -->
    <!-- ================================================================== -->

    <!-- Mod√®le pour la page d'inscription √©tudiant -->
    <template id="register-template">
        <div class="w-full max-w-lg mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-8">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">üéì Inscription √âtudiant</h1>
                    <p class="text-gray-500 mt-2">Rejoignez notre universit√© via ABM EduPilote</p>
                </div>
                <form id="inscriptionForm">
                    <input type="hidden" id="classe" name="classe" value="">
                    <div class="space-y-5">
                        <div>
                            <label for="nom" class="block text-sm font-medium text-gray-700 mb-1">Nom Complet</label>
                            <input type="text" id="nom" name="nom" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" placeholder="Ex: Moussa Diop">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Adresse Email</label>
                            <input type="email" id="email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" placeholder="Ex: m.diop@email.com">
                        </div>
                        <div>
                            <label for="filiereId" class="block text-sm font-medium text-gray-700 mb-1">Fili√®re</label>
                            <select id="filiereId" name="filiereId" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition bg-white">
                                <option value="" disabled selected>-- Choisissez une fili√®re --</option>
                                <!-- Options charg√©es dynamiquement -->
                            </select>
                        </div>
                        <div>
                            <label for="classeId" class="block text-sm font-medium text-gray-700 mb-1">Classe</label>
                            <select id="classeId" name="classeId" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition bg-gray-100" disabled>
                                <option value="" disabled selected>-- Choisissez d'abord une fili√®re --</option>
                                <!-- Options charg√©es dynamiquement -->
                            </select>
                        </div>
                    </div>
                    <div class="mt-8">
                        <button type="submit" id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <span id="btnText">Envoyer mon Inscription</span>
                            <span id="btnSpinner" class="hidden">Envoi en cours...</span>
                        </button>
                    </div>
                </form>
                <div id="messageArea" class="mt-6 text-center"></div>
            </div>
            <footer class="bg-gray-50 p-4 text-center text-sm text-gray-500">Propuls√© par <a href="#" class="font-bold text-indigo-600">ABM EduPilote</a></footer>
        </div>
    </template>

    <!-- NOUVEAU: Mod√®le pour l'enregistrement d'une nouvelle √©cole -->
    <template id="school-register-template">
        <div class="w-full max-w-lg mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-8">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">üè´ Enregistrer votre √âcole</h1>
                    <p class="text-gray-500 mt-2">Cr√©ez un compte pour votre √©tablissement sur ABM EduPilote.</p>
                </div>
                <form id="schoolRegisterForm">
                    <div class="space-y-5">
                        <div>
                            <label for="universityName" class="block text-sm font-medium text-gray-700 mb-1">Nom de votre Universit√©/√âcole</label>
                            <input type="text" id="universityName" name="universityName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="adminEmail" class="block text-sm font-medium text-gray-700 mb-1">Votre Email (Administrateur)</label>
                            <input type="email" id="adminEmail" name="adminEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">Votre Mot de Passe</label>
                            <input type="password" id="adminPassword" name="adminPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="mt-8"><button type="submit" id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-lg"><span id="btnText">Cr√©er le compte</span><span id="btnSpinner" class="hidden">Cr√©ation...</span></button></div>
                </form>
                <div id="messageArea" class="mt-6 text-center"></div>
            </div>
        </div>
    </template>

    <!-- Mod√®le pour la page de pr√©sence -->
    <template id="attendance-template">
        <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-8">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">üïí Feuille de Pr√©sence</h1>
                    <p class="text-gray-500 mt-2">Cours de <strong class="text-gray-700" id="matiere-display"></strong> pour la classe <strong class="text-gray-700" id="classe-display"></strong></p>
                </div>
                <form id="attendanceForm">
                    <input type="hidden" id="classe" name="classe" value="">
                    <input type="hidden" id="matiere" name="matiere" value="">
                    <div class="space-y-5">
                        <div>
                            <label for="studentId" class="block text-sm font-medium text-gray-700 mb-1">Votre ID √âtudiant</label>
                            <input type="text" id="studentId" name="studentId" required class="w-full text-center text-lg font-bold px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" placeholder="Ex: ETU-ABC123">
                        </div>
                    </div>
                    <div class="mt-8">
                        <button type="submit" id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <span id="btnText">Confirmer ma pr√©sence</span>
                            <span id="btnSpinner" class="hidden">Enregistrement...</span>
                        </button>
                    </div>
                </form>
                <div id="messageArea" class="mt-6 text-center"></div>
            </div>
            <footer class="bg-gray-50 p-4 text-center text-sm text-gray-500">Propuls√© par <a href="#" class="font-bold text-indigo-600">ABM EduPilote</a></footer>
        </div>
    </template>

    <!-- Mod√®le pour la page de connexion Admin -->
    <template id="admin-login-template">
        <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-8">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">üîë Acc√®s Administration</h1>
                    <p class="text-gray-500 mt-2">Veuillez entrer votre cl√© d'acc√®s.</p>
                </div>
                <form id="schoolLoginForm">
                    <div class="space-y-5">
                        <div>
                            <label for="adminEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Administrateur</label>
                            <input type="email" id="adminEmail" name="adminEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="admin@ecole.com">
                        </div>
                        <div>
                            <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                            <input type="password" id="adminPassword" name="adminPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                    <div class="mt-8">
                        <button type="submit" id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <span id="btnText">Se Connecter</span>
                            <span id="btnSpinner" class="hidden">V√©rification...</span>
                        </button>
                    </div>
                </form>
                <div id="messageArea" class="mt-6 text-center"></div>
                <div class="mt-4 text-center text-sm">
                    <a href="?page=school-register" class="font-medium text-indigo-600 hover:text-indigo-500">Pas encore de compte ? Enregistrez votre √©cole</a>
                </div>
            </div>
        </div>
    </template>

    <!-- Mod√®le pour le panneau d'administration -->
    <template id="admin-panel-template">
        <div class="max-w-4xl mx-auto">
            <header class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-800">üéì Panneau d'Administration</h1>
                <p class="text-gray-600 mt-2">G√©rez votre syst√®me ABM EduPilote depuis cette interface.</p>
            </header>
            <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="action-card bg-white p-6 rounded-xl shadow-md cursor-pointer" onclick="callAdminAction('admin_get_qr_codes')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-green-100 text-green-600 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h-1m-1-6v1m-1-1H9m12 4h1m-1-1v-1m-1 1h-1m-1-1h-1m-1-1H9m-1 1H7m2 4H7m2 1v1m-1-1v-1m1-1h1m2-1h1m1 1h1m-1 1h-1m-1-1h-1m-1-1h-1m-1-1h-1m-1-1h-1" /></svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">G√©n√©rer les QR Codes</h2>
                            <p class="text-gray-500 text-sm">Affiche les QR codes pour chaque salle.</p>
                        </div>
                    </div>
                </div>
                <div class="action-card bg-white p-6 rounded-xl shadow-md cursor-pointer" onclick="callAdminAction('admin_get_reg_links')">
                    <div class="flex items-center space-x-4">
                        <div class="bg-purple-100 text-purple-600 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">G√©n√©rer les liens</h2>
                            <p class="text-gray-500 text-sm">Cr√©e les liens d'inscription par classe.</p>
                        </div>
                    </div>
                </div>
                <!-- NOUVEAU: Carte pour la gestion des entit√©s -->
                <div class="action-card bg-white p-6 rounded-xl shadow-md cursor-pointer" onclick="renderPage('admin-management-template', new URLSearchParams())">
                    <div class="flex items-center space-x-4">
                        <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Gestion des Entit√©s</h2>
                            <p class="text-gray-500 text-sm">G√©rer universit√©s, fili√®res et classes.</p>
                        </div>
                    </div>
                </div>
                <!-- NOUVEAU: Carte pour la gestion des entit√©s -->
                <div class="action-card bg-white p-6 rounded-xl shadow-md cursor-pointer" onclick="renderPage('admin-management-template', new URLSearchParams())">
                    <div class="flex items-center space-x-4">
                        <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Gestion des Entit√©s</h2>
                            <p class="text-gray-500 text-sm">G√©rer fili√®res et classes.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </template>

    <!-- NOUVEAU: Mod√®le pour la gestion des entit√©s -->
    <template id="admin-management-template">
        <div class="max-w-5xl mx-auto">
            <header class="mb-10">
                <button onclick="renderPage('admin-panel-template', new URLSearchParams())" class="text-indigo-600 hover:text-indigo-800 mb-4">&larr; Retour au panneau d'administration</button>
                <h1 class="text-4xl font-bold text-gray-800">üèõÔ∏è Gestion des Entit√©s</h1>
                <p class="text-gray-600 mt-2">Ajoutez et consultez les universit√©s, fili√®res et classes de votre syst√®me.</p>
            </header>

            <!-- Tabs -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button class="management-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="filiere-content">Fili√®res</button>
                    <button class="management-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-target="classe-content">Classes</button>
                </nav>
            </div>

            <!-- Contenu des onglets -->
            <div id="management-content-container">
                <!-- Contenu Fili√®res -->
                <div id="filiere-content" class="management-tab-content hidden">
                     <div class="grid md:grid-cols-3 gap-8">
                        <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-medium text-gray-900">Ajouter une Fili√®re</h3>
                            <form id="add-filiere-form" class="mt-4 space-y-4">
                                <div>
                                    <!-- L'universit√© parente est maintenant implicite -->
                                    <p class="text-sm text-gray-500">La fili√®re sera ajout√©e √† votre universit√©.</p>
                                </div>
                                <div>
                                    <label for="filiere-name" class="block text-sm font-medium text-gray-700">Nom de la fili√®re</label>
                                    <input type="text" id="filiere-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Ajouter</button>
                            </form>
                        </div>
                        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-medium text-gray-900">Fili√®res Existantes</h3>
                            <ul id="filiere-list" class="mt-4 space-y-2 max-h-96 overflow-y-auto"><li class="p-3 bg-gray-100 rounded-md">Chargement...</li></ul>
                        </div>
                    </div>
                </div>
                <!-- Contenu Classes -->
                <div id="classe-content" class="management-tab-content hidden">
                     <div class="grid md:grid-cols-3 gap-8">
                        <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-medium text-gray-900">Ajouter une Classe</h3>
                            <form id="add-classe-form" class="mt-4 space-y-4">
                                <div>
                                    <label for="classe-filiere-select" class="block text-sm font-medium text-gray-700">Fili√®re Parente</label>
                                    <select id="classe-filiere-select" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white focus:outline-none focus:ring-indigo-500 sm:text-sm"></select>
                                </div>
                                <div>
                                    <label for="classe-name" class="block text-sm font-medium text-gray-700">Nom de la classe (ex: L1-Info)</label>
                                    <input type="text" id="classe-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Ajouter</button>
                            </form>
                        </div>
                        <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-medium text-gray-900">Classes Existantes</h3>
                            <ul id="classe-list" class="mt-4 space-y-2 max-h-96 overflow-y-auto"><li class="p-3 bg-gray-100 rounded-md">Chargement...</li></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- NOUVEAU: Mod√®le pour une page de confirmation g√©n√©rique -->
    <template id="confirmation-template">
        <div class="w-full max-w-md mx-auto text-center">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <div id="confirmation-icon" class="w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center">
                    <!-- L'ic√¥ne (‚úì ou ‚úó) sera inject√©e ici par le script -->
                </div>
                <h1 id="confirmation-title" class="text-3xl font-bold text-gray-800"></h1>
                <p id="confirmation-message" class="text-gray-600 mt-4 text-lg"></p>
                <a href="/" class="mt-8 inline-block w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">
                    Retour √† l'accueil
                </a>
            </div>
        </div>
    </template>

    <!-- Mod√®le pour la page d'accueil par d√©faut -->
    <template id="landing-template">
        <div class="max-w-4xl mx-auto text-center">
            <div class="mb-12">
                <h1 class="text-5xl font-bold text-gray-800">Bienvenue sur ABM EduPilote</h1>
                <p class="text-gray-600 mt-4 text-xl">Votre plateforme de gestion universitaire tout-en-un.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Carte pour les administrateurs existants -->
                <a href="?page=admin" class="action-card block p-8 bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-indigo-100">
                        <span class="text-3xl">üîë</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900">Utiliser le Syst√®me</h2>
                    <p class="text-gray-600 mt-2">Connectez-vous √† votre espace administrateur pour g√©rer votre √©tablissement.</p>
                </a>

                <!-- Carte pour les nouvelles √©coles -->
                <a href="?page=school-register" class="action-card block p-8 bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-shadow duration-300">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center bg-green-100">
                        <span class="text-3xl">üè´</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900">Inscrire votre √âcole</h2>
                    <p class="text-gray-600 mt-2">Cr√©ez un nouveau compte pour votre universit√© et commencez √† utiliser ABM EduPilote.</p>
                </a>
            </div>
        </div>
    </template>

    <!-- ================================================================== -->
    <!-- √âL√âMENTS PARTAG√âS (Modale, Spinner) -->
    <!-- ================================================================== -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900">R√©sultat</h3>
                <div id="modal-content" class="mt-2 px-7 py-3 overflow-y-auto"></div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">Fermer</button>
                </div>
            </div>
        </div>
    </div>
    <div id="spinner-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <!-- ================================================================== -->
    <!-- SCRIPT PRINCIPAL -->
    <!-- ================================================================== -->
    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxQGc2CsynNNA88D7LZHEjAD4TdWrWabmOPrB6LDObvCA10Dw0_-J9Z42ZWkqr2zWIcvw/exec';
        const ADMIN_SESSION_KEY = 'abm_admin_session';

        // --- ROUTEUR PRINCIPAL ---
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const page = params.get('page');
            
            switch (page) {
                case 'register':
                    renderPage('register-template', params);
                    break;
                case 'school-register':
                    renderPage('school-register-template', params);
                    break;
                case 'attendance':
                    renderPage('attendance-template', params);
                    break;
                case 'admin':
                    // V√©rifier si l'admin est d√©j√† connect√© (sessionStorage)
                    if (sessionStorage.getItem(ADMIN_SESSION_KEY) === 'true') {
                        renderPage('admin-panel-template', params);
                    } else {
                        renderPage('admin-login-template', params);
                    }
                    break;
                default:
                    renderPage('landing-template', params);
            }
        });

        function renderPage(templateId, params) {
            const template = document.getElementById(templateId);
            const appContainer = document.getElementById('app-container');
            if (!template || !appContainer) return;

            const clone = template.content.cloneNode(true);
            appContainer.innerHTML = ''; // Vider le conteneur
            appContainer.appendChild(clone);

            // Appeler la fonction de setup sp√©cifique √† la page
            const pageName = templateId.split('-')[0];
            const setupFunction = `setup${pageName.charAt(0).toUpperCase() + pageName.slice(1)}Page`;
            if (typeof window[setupFunction] === 'function') {
                windowsetupFunction;
            }
        }

        // --- FONCTIONS DE SETUP PAR PAGE ---

        async function setupRegisterPage(params) {
            const classe = params.get('classe');
            if (classe) {
                document.getElementById('classe').value = classe;
            }
            document.getElementById('inscriptionForm').addEventListener('submit', handleRegistrationSubmit);

            // NOUVEAU: Charger les fili√®res et classes
            setLoading(true, true);
            try {
                const result = await callApi('get_registration_data');
                const { filieres, classes } = result.data;

                const filiereSelect = document.getElementById('filiereId');
                const classeSelect = document.getElementById('classeId');

                filieres.forEach(f => {
                    filiereSelect.innerHTML += `<option value="${f.id}">${f.name}</option>`;
                });

                filiereSelect.addEventListener('change', () => {
                    const selectedFiliereId = filiereSelect.value;
                    classeSelect.innerHTML = '<option value="" disabled selected>-- Choisissez une classe --</option>';
                    const filteredClasses = classes.filter(c => c.filiereId === selectedFiliereId);
                    filteredClasses.forEach(c => {
                        classeSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                    });
                    classeSelect.disabled = false;
                    classeSelect.classList.remove('bg-gray-100');
                });
            } catch (error) {
                renderConfirmationPage('Erreur de chargement', 'Impossible de charger les donn√©es d\'inscription. Veuillez r√©essayer plus tard.', 'error');
            } finally {
                setLoading(false, true);
            }
        }

        async function setupAttendancePage(params) {
            const classe = params.get('classe');
            if (!classe) {
                renderConfirmationPage('Erreur', 'Aucune classe sp√©cifi√©e dans l\'URL. Veuillez scanner un QR code valide.', 'error');
                return;
            }

            setLoading(true, true); // Affiche le spinner de page
            try {
                const result = await callApi('get_current_course', { classe: classe });
                const course = result.data;

                // Remplir le formulaire avec les informations du cours
                document.getElementById('classe').value = course.classe;
                document.getElementById('classe-display').textContent = course.classe;
                document.getElementById('matiere').value = course.matiere;
                document.getElementById('matiere-display').textContent = course.matiere;

                document.getElementById('attendanceForm').addEventListener('submit', handleAttendanceSubmit);

            } catch (error) {
                renderConfirmationPage('Formulaire non disponible', error.message, 'error');
            } finally {
                setLoading(false, true); // Cache le spinner de page
            }
        }

        function setupAdminloginPage(params) {
            document.getElementById('schoolLoginForm').addEventListener('submit', handleSchoolLoginSubmit);
        }

        function setupSchoolregisterPage(params) {
            document.getElementById('schoolRegisterForm').addEventListener('submit', handleSchoolRegisterSubmit);
        }

        function setupAdminmanagementPage(params) {
            const tabs = document.querySelectorAll('.management-tab');
            const tabContents = document.querySelectorAll('.management-tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('border-indigo-500', 'text-indigo-600'));
                    tabs.forEach(t => t.classList.add('border-transparent', 'text-gray-500'));
                    tab.classList.add('border-indigo-500', 'text-indigo-600');
                    tab.classList.remove('border-transparent', 'text-gray-500');
                    tabContents.forEach(c => c.classList.add('hidden'));
                    document.getElementById(tab.dataset.target).classList.remove('hidden');
                    const entityType = tab.dataset.target.split('-')[0];
                    loadAndRenderEntities(entityType);
                });
            });

            setupEntityForm('filiere', {});
            setupEntityForm('classe', { parent: 'filiere', parentSelectId: 'classe-filiere-select' });
        }

        function setupEntityForm(entityType, options) {
            const form = document.getElementById(`add-${entityType}-form`);
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById(`${entityType}-name`);
                const name = nameInput.value.trim();
                if (!name) return;

                const payload = { name };
                if (options.parent) {
                    const parentSelect = document.getElementById(options.parentSelectId);
                    payload.filiereId = parentSelect.value;
                }

                setLoading(true, true);
                try {
                    const result = await callAdminApi('admin_add_entity', { entityType, payload });
                    showModal('Succ√®s', result.message);
                    nameInput.value = '';
                    loadAndRenderEntities(entityType);
                } catch (error) {
                    showModal('Erreur', error.message);
                } finally {
                    setLoading(false, true);
                }
            });
        }

        function setupAdminpanelPage(params) {
            // La logique est dans les `onclick` des cartes, rien √† faire ici pour l'instant.
        }

        // --- GESTIONNAIRES DE SOUMISSION ---

        async function handleRegistrationSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                nom: form.nom.value,
                email: form.email.value,
                filiereId: form.filiereId.value, // D√©j√† un ID
                classeId: form.classeId.value   // D√©j√† un ID
            };
            setLoading(true); // Affiche le spinner du bouton
            try {
                const result = await callApi('inscrireEtudiant', data);
                renderConfirmationPage('Inscription R√©ussie !', result.message, 'success');
            } catch (error) {
                renderConfirmationPage('Erreur d\'inscription', error.message, 'error');
            }
        }

        async function handleAttendanceSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                studentId: form.studentId.value,
                classe: form.classe.value,
                matiere: form.matiere.value
            };
            setLoading(true); // Affiche le spinner du bouton
            try {
                const result = await callApi('recordAttendance', data);
                renderConfirmationPage('Pr√©sence Enregistr√©e', result.message, 'success');
            } catch (error) {
                renderConfirmationPage('Erreur de Pointage', error.message, 'error');
            }
        }

        async function handleAdminLoginSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const data = { adminKey: form.adminKey.value };
            setLoading(true);
            try {
                const result = await callApi('login_school', { email: form.adminEmail.value, password: form.adminPassword.value });
                sessionStorage.setItem(ADMIN_SESSION_KEY, result.token); // Stocke l'ID de l'universit√©
                renderPage('admin-panel-template', new URLSearchParams()); // Redirige vers le panneau admin
            } catch (error) {
                // Pour une erreur de login, on affiche juste le message dans le formulaire
                displayMessageInForm(error.message, 'error');
                sessionStorage.removeItem(ADMIN_SESSION_KEY);
            } finally {
                setLoading(false); // Cache le spinner du bouton
            }
        }

        async function handleSchoolRegisterSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                universityName: form.universityName.value,
                adminEmail: form.adminEmail.value,
                adminPassword: form.adminPassword.value
            };
            setLoading(true);
            try {
                const result = await callApi('register_school', data);
                renderConfirmationPage('Compte √âcole Cr√©√© !', `${result.message} Vous pouvez maintenant vous connecter.`, 'success');
            } catch (error) {
                displayMessageInForm(error.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        async function loadAndRenderEntities(entityType) {
            const listElement = document.getElementById(`${entityType}-list`);
            if (!listElement) return;
            listElement.innerHTML = '<li class="p-3 bg-gray-100 rounded-md">Chargement...</li>';

            try {
                const result = await callAdminApi('admin_get_entities', { entityType });
                const entities = result.data;

                // Remplir les listes d√©roulantes pour les formulaires d'ajout
                if (entityType === 'filiere') {
                    const parentSelectId = 'classe-filiere-select';
                    const parentSelect = document.getElementById(parentSelectId);
                    if (parentSelect) {
                        parentSelect.innerHTML = '<option value="">-- S√©lectionnez une fili√®re --</option>' 
                            + entities.map(e => `<option value="${e.ID_FILIERE}">${e.NOM_FILIERE}</option>`).join('');
                    }
                }

                if (entities.length === 0) {
                    listElement.innerHTML = '<li class="p-3 bg-gray-100 rounded-md text-gray-500">Aucune entit√© trouv√©e.</li>';
                    return;
                }

                listElement.innerHTML = entities.map(entity => {
                    let parentInfo = '';
                    if (entity.ID_UNIVERSITE_FK) parentInfo = `<span class="text-xs text-gray-400 ml-2">(Univ: ${entity.ID_UNIVERSITE_FK})</span>`;
                    if (entity.ID_FILIERE_FK) parentInfo = `<span class="text-xs text-gray-400 ml-2">(Fili√®re: ${entity.ID_FILIERE_FK})</span>`;

                    return `
                        <li class="p-3 bg-white border rounded-md flex justify-between items-center">
                            <span>${entity[`NOM_${entityType.toUpperCase()}`]} ${parentInfo}</span>
                            <span class="text-xs text-gray-400 font-mono">${entity[`ID_${entityType.toUpperCase()}`]}</span>
                        </li>
                    `;
                }).join('');

            } catch (error) {
                listElement.innerHTML = `<li class="p-3 bg-red-100 text-red-700 rounded-md">Erreur: ${error.message}</li>`;
            }
        }
        // --- FONCTIONS UTILITAIRES ---

        async function callApi(action, data = {}) {
            if (!WEB_APP_URL) throw new Error('URL de l\'API non configur√©e.');
            
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action, data })
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Erreur inconnue de l\'API.');
            return result;
        }

        async function callAdminApi(action, data = {}) {
            const token = sessionStorage.getItem(ADMIN_SESSION_KEY);
            if (!token) {
                // Rediriger vers la page de login si le token n'est pas trouv√©
                renderPage('school-login-template', new URLSearchParams());
                throw new Error('Non authentifi√©.');
            }
            return callApi(action, { ...data, universityId: token });
        }

        async function callAdminAction(actionName) {
            const spinnerOverlay = document.getElementById('spinner-overlay');
            spinnerOverlay.classList.remove('hidden');
            try {
                const result = await callApi(actionName);
                if (result.html) {
                    showModal('R√©sultat de l\'op√©ration', result.html);
                } else if (result.message) {
                    showModal('Op√©ration termin√©e', `<p class="text-green-600 font-semibold">${result.message}</p>`);
                }
            } catch (error) {
                showModal('Erreur', `<p class="text-red-600 font-semibold">${error.message}</p>`);
            } finally {
                spinnerOverlay.classList.add('hidden');
            }
        }

        function setLoading(isLoading, isPageLoad = false) {
            const spinnerOverlay = document.getElementById('spinner-overlay');
            if (isPageLoad && spinnerOverlay) {
                spinnerOverlay.classList.toggle('hidden', !isLoading);
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            if (!submitBtn || !btnText || !btnSpinner) return;
            
            submitBtn.disabled = isLoading;
            btnText.classList.toggle('hidden', isLoading);
            btnSpinner.classList.toggle('hidden', !isLoading);
        }
        function displayMessageInForm(message, type) { // Renamed from displayMessage
            const messageArea = document.getElementById('messageArea');
            if (!messageArea) return;
            const colorClass = type === 'success' ? 'text-green-600' : 'text-red-600';
            const bgColorClass = type === 'success' ? 'bg-green-50' : 'bg-red-50';
            const borderColorClass = type === 'success' ? 'border-green-200' : 'border-red-200';
            messageArea.innerHTML = `<div class="border ${borderColorClass} ${bgColorClass} ${colorClass} px-4 py-3 rounded-lg"><strong class="font-bold">${type === 'success' ? 'Succ√®s !' : 'Erreur !'}</strong><span class="block sm:inline"> ${message}</span></div>`;
        }

        function renderConfirmationPage(title, message, type = 'success') {
            const template = document.getElementById('confirmation-template');
            const appContainer = document.getElementById('app-container');
            if (!template || !appContainer) return;

            const clone = template.content.cloneNode(true);
            
            const iconContainer = clone.querySelector('#confirmation-icon');
            const titleEl = clone.querySelector('#confirmation-title');
            const messageEl = clone.querySelector('#confirmation-message');

            if (type === 'success') {
                iconContainer.className = 'w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center bg-green-100';
                iconContainer.innerHTML = `<span class="text-5xl text-green-600">‚úì</span>`;
                titleEl.textContent = title || 'Succ√®s !';
            } else {
                iconContainer.className = 'w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center bg-red-100';
                iconContainer.innerHTML = `<span class="text-5xl text-red-600">‚úó</span>`;
                titleEl.textContent = title || 'Erreur';
            }
            messageEl.textContent = message;

            appContainer.innerHTML = '';
            appContainer.appendChild(clone);
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('close-modal').onclick = () => document.getElementById('modal').classList.add('hidden');
        }
    </script>

</body>
</html>
                <div class="space-y-5">
                    <div>
                        <label for="nom" class="block text-sm font-medium text-gray-700 mb-1">Nom Complet</label>
                        <input type="text" id="nom" name="nom" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" placeholder="Ex: Moussa Diop">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Adresse Email</label>
                        <input type="email" id="email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition" placeholder="Ex: m.diop@email.com">
                    </div>
                    <div>
                        <label for="filiere" class="block text-sm font-medium text-gray-700 mb-1">Fili√®re souhait√©e</label>
                        <select id="filiere" name="filiere" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition bg-white">
                            <option value="" disabled selected>-- Choisissez une fili√®re --</option>
                            <option value="Informatique de Gestion">Informatique de Gestion</option>
                            <option value="Marketing & Communication">Marketing & Communication</option>
                            <option value="Finance & Comptabilit√©">Finance & Comptabilit√©</option>
                            <option value="Droit des Affaires">Droit des Affaires</option>
                            <!-- Ajoutez d'autres fili√®res ici -->
                        </select>
                    </div>
                </div>

                <div class="mt-8">
                    <button type="submit" id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <span id="btnText">Envoyer mon Inscription</span>
                        <span id="btnSpinner" class="hidden">Envoi en cours...</span>
                    </button>
                </div>
            </form>
            
            <!-- Zone de message -->
            <div id="messageArea" class="mt-6 text-center"></div>

        </div>
        <footer class="bg-gray-50 p-4 text-center text-sm text-gray-500">
            Propuls√© par <a href="#" class="font-bold text-indigo-600">ABM EduPilote</a>
        </footer>
    </div>

    <script>
        // ==================================================================
        // --- CONFIGURATION REQUISE ---
        // Collez ici l'URL de votre application web Google Apps Script.
        // Vous l'obtenez apr√®s avoir cliqu√© sur "D√©ployer" > "Nouveau d√©ploiement".
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxQGc2CsynNNA88D7LZHEjAD4TdWrWabmOPrB6LDObvCA10Dw0_-J9Z42ZWkqr2zWIcvw/exec';
        // ==================================================================

        const form = document.getElementById('inscriptionForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        const messageArea = document.getElementById('messageArea');
        const classeInput = document.getElementById('classe');

        // NOUVEAU: R√©cup√©rer la classe depuis l'URL de la page
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const classe = urlParams.get('classe');
            if (classe) {
                classeInput.value = classe;
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (WEB_APP_URL.includes('COLLEZ_VOTRE_URL_APPS_SCRIPT_ICI') || !WEB_APP_URL) {
                displayMessage('ERREUR DE CONFIGURATION : Veuillez coller l\'URL de votre Apps Script dans le fichier index.html.', 'error');
                return;
            }

            // D√©sactiver le bouton et afficher le spinner
            setLoading(true);

            const formData = new FormData(form);
            const data = {
                nom: formData.get('nom'),
                email: formData.get('email'),
                filiere: formData.get('filiere'),
                classe: formData.get('classe') // Ajout de la classe
            };

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Recommand√© pour Apps Script
                    },
                    body: JSON.stringify({
                        action: 'inscrireEtudiant',
                        data: data
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayMessage(result.message, 'success');
                    form.reset();
                    form.style.display = 'none'; // Cacher le formulaire apr√®s succ√®s
                } else {
                    displayMessage(`Erreur : ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Erreur de communication:', error);
                displayMessage('Une erreur de r√©seau est survenue. Veuillez r√©essayer.', 'error');
            } finally {
                // R√©activer le bouton
                setLoading(false);
            }
        });

        function setLoading(isLoading) {
            submitBtn.disabled = isLoading;
            if (isLoading) {
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');
            } else {
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            }
        }

        function displayMessage(message, type) {
            const colorClass = type === 'success' ? 'text-green-600' : 'text-red-600';
            const bgColorClass = type === 'success' ? 'bg-green-50' : 'bg-red-50';
            const borderColorClass = type === 'success' ? 'border-green-200' : 'border-red-200';

            messageArea.innerHTML = `
                <div class="border ${borderColorClass} ${bgColorClass} ${colorClass} px-4 py-3 rounded-lg">
                    <strong class="font-bold">${type === 'success' ? 'Succ√®s !' : 'Erreur !'}</strong>
                    <span class="block sm:inline"> ${message}</span>
                </div>
            `;
        }
    </script>

</body>
</html>
