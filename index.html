// ============================================================================
// SYST√àME DE GESTION UNIVERSITAIRE - ABM
// D√©velopp√© par Gemini Code Assist pour Africa Business Manager
// Version 2.0 - 2024 (avec API pour formulaire externe)
// ============================================================================

// --- CONFIGURATION GLOBALE ---
const SHEET_NAMES = {
  CONFIG: 'Configuration',
  STUDENTS: '√âtudiants',
  PLANNING: 'Planning',
  SCAN: 'Scan',
  CONDUCT: 'Conduite',
  ADMINS: 'Administrateurs',
  UNIVERSITIES: 'Universit√©s',
  FILIERES: 'Fili√®res',
  CLASSES: 'Classes'
};

const CONFIG_KEYS = {
  ADMIN_EMAIL: 'ADMIN_EMAIL',
  FRONTEND_URL: 'FRONTEND_URL', // NOUVEAU: Pour l'URL de votre site Netlify/Vercel
  ADMIN_KEY: 'ADMIN_KEY' // NOUVEAU: Pour s√©curiser le panneau d'administration
};

// ============================================================================
// POINT D'ENTR√âE WEB APP (doGet pour QR Codes, doPost pour API)
// ============================================================================

/**
 * G√®re les requ√™tes GET (scans de QR Code).
 */
function doGet(e) {
  // La fonction doGet n'est plus utilis√©e pour servir des pages HTML.
  // Tout le frontend est maintenant g√©r√© par un service externe (Netlify/Vercel).
  // On peut la garder pour des tests de connectivit√© simples.
  return createJsonResponse({ success: true, message: 'ABM EduPilote Backend v3.0 - Actif' });
}

/**
 * NOUVEAU : G√®re les requ√™tes POST (API pour le formulaire Vercel).
 * C'est le routeur principal pour les actions externes.
 */
function doPost(e) {
  try {
    // On parse les donn√©es envoy√©es par le formulaire Vercel
    const request = JSON.parse(e.postData.contents);
    
    if (!request.action) {
      return createJsonResponse({ success: false, error: 'Action non sp√©cifi√©e.' });
    }

    // On dirige vers la bonne fonction en fonction de l'action demand√©e
    switch (request.action) {
      case 'inscrireEtudiant':
        return inscrireEtudiant(request.data);
      case 'recordAttendance': // NOUVELLE ACTION
        return recordAttendance(request.data);
      case 'get_current_course': // NOUVELLE ACTION
        return getCurrentCourse(request.data);
      case 'admin_login': // NOUVELLE ACTION
        return adminLogin(request.data);
      case 'get_registration_data': // NOUVELLE ACTION
        return getRegistrationData(request.data);
      case 'register_school': // NOUVELLE ACTION
        return registerSchool(request.data);
      case 'login_school': // NOUVELLE ACTION
        return loginSchool(request.data);
      case 'admin_get_entities': // NOUVELLE ACTION
        return getEntitiesForAdmin(request.data);
      case 'admin_add_entity': // NOUVELLE ACTION
        return addEntityForAdmin(request.data);
      // NOUVEAU: Actions pour le panneau d'administration
      case 'admin_get_qr_codes':
        return generateQrCodeUrlsForAdmin(request.data);
      case 'admin_get_reg_links':
        return generateRegistrationLinksForAdmin(request.data);
      
      // Vous pourrez ajouter d'autres actions ici plus tard
      // case 'autreAction':
      //   return autreAction(request.data);

      default:
        return createJsonResponse({ success: false, error: 'Action non reconnue.' });
    }

  } catch (error) {
    Logger.log(`Erreur doPost: ${error.toString()}`);
    return createJsonResponse({ success: false, error: `Erreur serveur: ${error.message}` });
  }
}

// ============================================================================
// FONCTIONS DE L'API (appel√©es par doPost)
// ============================================================================

/**
 * NOUVEAU : Inscrit un nouvel √©tudiant dans l'onglet "√âtudiants".
 */
function inscrireEtudiant(data) {
  try {
    const { nom, email, filiereId, classeId, universityId } = data;
    if (!nom || !email || !filiereId || !classeId || !universityId) {
      return createJsonResponse({ success: false, error: 'Donn√©es manquantes. Tous les champs sont obligatoires.' });
    }

    const studentsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.STUDENTS);
    
    // G√©n√©rer un ID √©tudiant unique et simple
    const newId = `ETU-${Utilities.getUuid().substring(0, 6).toUpperCase()}`;
    
    // Ajouter le nouvel √©tudiant √† la feuille avec l'ID de l'universit√©
    studentsSheet.appendRow([
      newId,
      nom,
      filiereId,
      classeId,
      email,
      universityId,
      new Date() // DATE_INSCRIPTION
    ]);

    const successMessage = `Inscription r√©ussie pour ${nom} ! Votre ID √©tudiant est : ${newId}`;

    // Renvoyer une r√©ponse de succ√®s au formulaire Vercel
    return createJsonResponse({ success: true, message: successMessage });

  } catch (error) {
    Logger.log(`Erreur inscrireEtudiant: ${error.toString()}`);
    return createJsonResponse({ success: false, error: `Erreur interne lors de l'inscription: ${error.message}` });
  }
}

/**
 * NOUVEAU : R√©cup√®re les donn√©es n√©cessaires pour le formulaire d'inscription (fili√®res, classes).
 */
function getRegistrationData(data) {
    try {
        const { universityId } = data;
        if (!universityId) {
          return createJsonResponse({ success: false, error: "ID de l'universit√© manquant." });
        }

        const filieresSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.FILIERES);
        const classesSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.CLASSES);

        const filieresData = filieresSheet.getDataRange().getValues();
        const filieresHeaders = filieresData.shift();
        const filieres = filieresData
            .filter(row => row[filieresHeaders.indexOf('ID_UNIVERSITE_FK')] === universityId)
            .map(row => ({
                id: row[filieresHeaders.indexOf('ID_FILIERE')],
                name: row[filieresHeaders.indexOf('NOM_FILIERE')]
            }));

        const filiereIdsForUniversity = filieres.map(f => f.id);

        const classesData = classesSheet.getDataRange().getValues();
        const classesHeaders = classesData.shift();
        const classes = classesData
            .filter(row => filiereIdsForUniversity.includes(row[classesHeaders.indexOf('ID_FILIERE_FK')]))
            .map(row => ({
                id: row[classesHeaders.indexOf('ID_CLASSE')],
                name: row[classesHeaders.indexOf('NOM_CLASSE')],
                filiereId: row[classesHeaders.indexOf('ID_FILIERE_FK')]
            }));

        return createJsonResponse({ success: true, data: { filieres, classes } });
    } catch (error) {
        return createJsonResponse({ success: false, error: `Erreur de r√©cup√©ration des donn√©es: ${error.message}` });
    }
}

/**
 * NOUVEAU : Enregistre une nouvelle √©cole/universit√© et son administrateur.
 */
function registerSchool(data) {
  try {
    const { universityName, adminEmail, adminPassword } = data;
    if (!universityName || !adminEmail || !adminPassword) {
      return createJsonResponse({ success: false, error: 'Toutes les informations sont requises pour cr√©er un compte √©cole.' });
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const adminsSheet = ss.getSheetByName(SHEET_NAMES.ADMINS);
    const universitiesSheet = ss.getSheetByName(SHEET_NAMES.UNIVERSITIES);

    // V√©rifier si l'email de l'admin n'est pas d√©j√† pris
    const adminEmails = adminsSheet.getRange(2, 2, adminsSheet.getLastRow(), 1).getValues().flat();
    if (adminEmails.includes(adminEmail)) {
      return createJsonResponse({ success: false, error: 'Cette adresse email est d√©j√† utilis√©e par un autre administrateur.' });
    }

    // Cr√©er la nouvelle universit√©
    const newUniversityId = `UNIV-${Utilities.getUuid().substring(0, 4).toUpperCase()}`;
    universitiesSheet.appendRow([newUniversityId, universityName]);

    // Cr√©er le nouvel administrateur
    const newAdminId = `ADM-${Utilities.getUuid().substring(0, 4).toUpperCase()}`;
    // ATTENTION: Stocker le mot de passe en clair est une faille de s√©curit√© majeure.
    // Pour une vraie application, il faudrait le "hasher".
    adminsSheet.appendRow([newAdminId, adminEmail, adminPassword, newUniversityId]);

    return createJsonResponse({ success: true, message: `L'universit√© "${universityName}" a √©t√© cr√©√©e avec succ√®s. Vous pouvez maintenant vous connecter.` });
  } catch (error) {
    return createJsonResponse({ success: false, error: `Erreur lors de la cr√©ation de l'√©cole: ${error.message}` });
  }
}

/**
 * NOUVEAU : Connecte un administrateur d'√©cole.
 */
function loginSchool(data) {
  try {
    const { email, password } = data;
    if (!email || !password) {
      return createJsonResponse({ success: false, error: 'Email et mot de passe requis.' });
    }

    const adminsSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.ADMINS);
    const adminsData = adminsSheet.getDataRange().getValues();
    const headers = adminsData.shift();
    const emailIdx = headers.indexOf('EMAIL_ADMIN');
    const passIdx = headers.indexOf('PASSWORD');
    const univIdIdx = headers.indexOf('ID_UNIVERSITE_FK');

    for (const row of adminsData) {
      if (row[emailIdx] === email && row[passIdx] === password) {
        // Le "token" est simplement l'ID de l'universit√© pour cette version simplifi√©e.
        return createJsonResponse({ success: true, message: 'Connexion r√©ussie.', token: row[univIdIdx], universityId: row[univIdIdx] });
      }
    }
    return createJsonResponse({ success: false, error: 'Email ou mot de passe incorrect.' });
  } catch (error) {
    return createJsonResponse({ success: false, error: `Erreur interne: ${error.message}` });
  }
}
/**
 * NOUVEAU : R√©cup√®re la liste des entit√©s (universit√©s, fili√®res, classes).
 */
function getEntitiesForAdmin(data) {
  try {
    const { entityType, universityId } = data;
    if (!universityId) {
        return createJsonResponse({ success: false, error: "Session administrateur invalide." });
    }

    const sheetName = getSheetNameForEntity(entityType);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
    if (!sheet) {
      return createJsonResponse({ success: false, error: `L'entit√© '${entityType}' est inconnue.` });
    }
    const values = sheet.getDataRange().getValues();
    const headers = values.shift() || [];
    
    let filteredValues = values;

    if (entityType === 'filiere') {
        const univFkIdx = headers.indexOf('ID_UNIVERSITE_FK');
        filteredValues = values.filter(row => row[univFkIdx] === universityId);
    } else if (entityType === 'classe') {
        const filieresSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.FILIERES);
        const filieresData = filieresSheet.getDataRange().getValues();
        const filieresHeaders = filieresData.shift();
        const filiereUnivFkIdx = filieresHeaders.indexOf('ID_UNIVERSITE_FK');
        const filiereIdIdx = filieresHeaders.indexOf('ID_FILIERE');
        const allowedFiliereIds = filieresData
            .filter(row => row[filiereUnivFkIdx] === universityId)
            .map(row => row[filiereIdIdx]);
        
        const classeFkIdx = headers.indexOf('ID_FILIERE_FK');
        filteredValues = values.filter(row => allowedFiliereIds.includes(row[classeFkIdx]));
    }

    const entities = filteredValues.map(row => {
      const entity = {};
      headers.forEach((header, i) => {
        entity[header] = row[i];
      });
      return entity;
    });
    return createJsonResponse({ success: true, data: entities });
  } catch (error) {
    return createJsonResponse({ success: false, error: error.message });
  }
}

/**
 * NOUVEAU : Ajoute une nouvelle entit√©.
 */
function addEntityForAdmin(data) {
  try {
    const { entityType, payload, universityId } = data;
    if (!entityType || !payload || !payload.name) {
      return createJsonResponse({ success: false, error: 'Donn√©es invalides. Le nom est obligatoire.' });
    }
    const sheetName = getSheetNameForEntity(entityType);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
    if (!sheet) {
      return createJsonResponse({ success: false, error: `L'entit√© '${entityType}' est inconnue.` });
    }
    
    const newId = `${entityType.substring(0, 3).toUpperCase()}-${Utilities.getUuid().substring(0, 4).toUpperCase()}`;
    
    let rowData;
    if (entityType === 'filiere') {
        if (!universityId) return createJsonResponse({ success: false, error: 'ID Universit√© manquant pour lier la fili√®re.' });
        rowData = [newId, payload.name, universityId];
    } else if (entityType === 'classe') {
        if (!payload.filiereId) return createJsonResponse({ success: false, error: 'ID Fili√®re manquant.' });
        rowData = [newId, payload.name, payload.filiereId];
    } else {
        throw new Error('Type d\'entit√© non g√©r√© pour l\'ajout.');
    }
    sheet.appendRow(rowData);

    return createJsonResponse({ success: true, message: `"${payload.name}" a √©t√© ajout√© avec succ√®s.` });
  } catch (error) {
    return createJsonResponse({ success: false, error: error.message });
  }
}
/**
 * NOUVEAU : Enregistre la pr√©sence d'un √©tudiant depuis le formulaire HTML.
 */
function recordAttendance(data) {
  try {
    const { studentId, classe, matiere } = data;
    if (!studentId || !classe || !matiere) {
      return createJsonResponse({ success: false, error: 'Donn√©es de pr√©sence manquantes.' });
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const scanSheet = ss.getSheetByName(SHEET_NAMES.SCAN);
    const studentsSheet = ss.getSheetByName(SHEET_NAMES.STUDENTS);

    // Trouver le nom de l'√©tudiant
    const studentsData = studentsSheet.getRange(2, 1, studentsSheet.getLastRow() - 1, 2).getValues(); // ID et Nom
    let studentName = 'Inconnu';
    for (const row of studentsData) {
      if (row[0].toString().trim().toUpperCase() === studentId.trim().toUpperCase()) {
        studentName = row[1];
        break;
      }
    }

    const timestamp = new Date();
    scanSheet.appendRow([timestamp, studentId, studentName, classe, matiere, Utilities.formatDate(timestamp, Session.getScriptTimeZone(), 'yyyy-MM-dd'), Utilities.formatDate(timestamp, Session.getScriptTimeZone(), 'HH:mm:ss'), 'Pr√©sent']);

    return createJsonResponse({ success: true, message: `Pr√©sence enregistr√©e avec succ√®s pour ${studentName} (${studentId}).` });
  } catch (error) {
    Logger.log(`Erreur recordAttendance: ${error.toString()}`);
    return createJsonResponse({ success: false, error: `Erreur interne lors de l'enregistrement: ${error.message}` });
  }
}

/**
 * NOUVEAU : Trouve le cours actuel pour une classe donn√©e.
 */
function getCurrentCourse(data) {
  try {
    const { classe } = data;
    if (!classe) {
      return createJsonResponse({ success: false, error: 'Param√®tre "classe" manquant.' });
    }

    const planningSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.PLANNING);
    if (!planningSheet) {
      return createJsonResponse({ success: false, error: 'Erreur Syst√®me: L\'onglet "Planning" est introuvable.' });
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const planningData = planningSheet.getDataRange().getValues();
    const headers = planningData.shift();
    
    const classeIdx = headers.indexOf('CLASSE');
    const matiereIdx = headers.indexOf('MATIERE');
    const dateIdx = headers.indexOf('DATE_COURS');
    const statutIdx = headers.indexOf('STATUT');

    if ([classeIdx, matiereIdx, dateIdx, statutIdx].includes(-1)) {
        return createJsonResponse({ success: false, error: 'Erreur de Configuration: Colonnes manquantes dans Planning.' });
    }

    for (const row of planningData) {
      const courseDate = new Date(row[dateIdx]);
      courseDate.setHours(0, 0, 0, 0);

      if (row[classeIdx] == classe && courseDate.getTime() === today.getTime() && row[statutIdx] === 'Confirm√©') {
        const courseFound = { classe: row[classeIdx], matiere: row[matiereIdx] };
        return createJsonResponse({ success: true, data: courseFound });
      }
    }

    return createJsonResponse({ success: false, error: `Aucun cours confirm√© pour la classe ${classe} aujourd'hui.` });

  } catch (error) {
    Logger.log(`Erreur getCurrentCourse: ${error.toString()}`);
    return createJsonResponse({ success: false, error: `Erreur interne: ${error.message}` });
  }
}
/**
 * NOUVEAU : V√©rifie la cl√© d'administration.
 */
function adminLogin(data) {
  try {
    const { adminKey } = data;
    if (!adminKey) {
      return createJsonResponse({ success: false, error: 'Cl√© d\'administration manquante.' });
    }
    const config = getConfiguration();
    if (config.ADMIN_KEY && config.ADMIN_KEY === adminKey) {
      return createJsonResponse({ success: true, message: 'Connexion r√©ussie.' });
    } else {
      return createJsonResponse({ success: false, error: 'Cl√© d\'administration incorrecte.' });
    }
  } catch (error) {
    return createJsonResponse({ success: false, error: `Erreur interne: ${error.message}` });
  }
}
// ============================================================================
// FONCTIONS D'INITIALISATION ET UTILITAIRES (Mises √† jour)
// ============================================================================

/**
 * Initialise la structure du Google Sheet (onglets, en-t√™tes).
 * MISE √Ä JOUR : Ajout de la colonne DATE_INSCRIPTION.
 */
function setup() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Confirmation de la Configuration',
    'Cette action va configurer votre Google Sheet pour ABM EduPilote. TOUTES les donn√©es et onglets existants seront supprim√©s et remplac√©s. √ätes-vous s√ªr de vouloir continuer ?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    ui.alert('Configuration annul√©e.');
    return;
  }

  try {
    // 1. Nettoyer le Google Sheet
    ss.getSheets().forEach(sheet => {
      if (ss.getSheets().length > 1) { ss.deleteSheet(sheet); }
    });
    ss.getSheets()[0].setName('TEMP').clear();

    // 2. D√©finir la structure compl√®te
    const sheetConfigs = {
      [SHEET_NAMES.CONFIG]: { headers: ['Cl√©', 'Valeur'], color: '#f4b400', validations: {} },
      [SHEET_NAMES.UNIVERSITIES]: { headers: ['ID_UNIVERSITE', 'NOM_UNIVERSITE'], color: '#a61c00', validations: {} },
      [SHEET_NAMES.FILIERES]: { headers: ['ID_FILIERE', 'NOM_FILIERE', 'ID_UNIVERSITE_FK'], color: '#a61c00', validations: {} },
      [SHEET_NAMES.CLASSES]: { headers: ['ID_CLASSE', 'NOM_CLASSE', 'ID_FILIERE_FK'], color: '#a61c00', validations: {} },
      [SHEET_NAMES.ADMINS]: { headers: ['ID_ADMIN', 'EMAIL_ADMIN', 'PASSWORD', 'ID_UNIVERSITE_FK'], color: '#a61c00', validations: {} },
      [SHEET_NAMES.STUDENTS]: { headers: ['ID_ETUDIANT', 'NOM_COMPLET', 'ID_FILIERE_FK', 'ID_CLASSE_FK', 'EMAIL', 'ID_UNIVERSITE_FK', 'DATE_INSCRIPTION'], color: '#4285f4', validations: {} },
      [SHEET_NAMES.PLANNING]: { headers: ['ID_COURS', 'CLASSE', 'MATIERE', 'ENSEIGNANT', 'DATE_COURS', 'HEURE_DEBUT', 'HEURE_FIN', 'STATUT'], color: '#0f9d58', validations: { 'STATUT': ['Confirm√©', 'Annul√©', 'En attente'] } },
      [SHEET_NAMES.SCAN]: { headers: ['TIMESTAMP', 'ID_ETUDIANT', 'NOM_ETUDIANT', 'CLASSE', 'MATIERE', 'DATE_SCAN', 'HEURE_SCAN', 'STATUT_PRESENCE'], color: '#db4437', validations: { 'STATUT_PRESENCE': ['Pr√©sent', 'Absent', 'En retard', 'Justifi√©'] } },
      [SHEET_NAMES.CONDUCT]: { headers: ['ID_INCIDENT', 'DATE', 'ID_ETUDIANT', 'NOM_ETUDIANT', 'CLASSE', 'DESCRIPTION_INCIDENT', 'MESURE_PRISE'], color: '#673ab7', validations: {} }
    };

    // 3. Cr√©er et formater les onglets
    Object.entries(sheetConfigs).forEach(([name, config]) => {
      const sheet = ss.insertSheet(name);
      sheet.setTabColor(config.color);
      const headerRange = sheet.getRange(1, 1, 1, config.headers.length);
      headerRange.setValues([config.headers]);
      headerRange.setBackground(config.color).setFontColor('#ffffff').setFontWeight('bold').setHorizontalAlignment('center');
      sheet.setFrozenRows(1);

      const headers = config.headers;
      for (const colName in config.validations) {
        const colIndex = headers.indexOf(colName);
        if (colIndex !== -1) {
          const rule = SpreadsheetApp.newDataValidation().requireValueInList(config.validations[colName]).setAllowInvalid(false).build();
          sheet.getRange(2, colIndex + 1, sheet.getMaxRows() - 1, 1).setDataValidation(rule);
        }
      }
      config.headers.forEach((header, i) => sheet.autoResizeColumn(i + 1));
    });

    ss.deleteSheet(ss.getSheetByName('TEMP'));

    // 4. Remplir l'onglet Configuration
    const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
    const configData = [
      [CONFIG_KEYS.ADMIN_EMAIL, 'METTRE_VOTRE_EMAIL_ICI'],
      [CONFIG_KEYS.FRONTEND_URL, 'https://abm-edupilote.netlify.app/'],
      [CONFIG_KEYS.ADMIN_KEY, `admin-${Utilities.getUuid().substring(0, 8)}`] // G√©n√®re une cl√© admin par d√©faut
    ];
    configSheet.getRange(2, 1, configData.length, 2).setValues(configData);
    configSheet.autoResizeColumns(1, 2);

    // 5. Ajouter des donn√©es de d√©monstration pour les entit√©s
    const univId = 'UNIV-DEMO';
    const adminId = 'ADM-DEMO';
    ss.getSheetByName(SHEET_NAMES.UNIVERSITIES).getRange(2, 1, 1, 2).setValues([[univId, 'Universit√© Virtuelle de Dakar']]);
    ss.getSheetByName(SHEET_NAMES.ADMINS).getRange(2, 1, 1, 4).setValues([[adminId, 'admin@demo.com', 'password', univId]]);
    
    const filieresSheet = ss.getSheetByName(SHEET_NAMES.FILIERES);
    const demoFilieres = [
        ['FIL-INFO', 'Informatique de Gestion', 'UNIV-DEMO'],
        ['FIL-DROIT', 'Droit des Affaires', 'UNIV-DEMO']
    ];
    filieresSheet.getRange(2, 1, demoFilieres.length, demoFilieres[0].length).setValues(demoFilieres);

    const classesSheet = ss.getSheetByName(SHEET_NAMES.CLASSES);
    const demoClasses = [
        ['CLS-L1INFO', 'L1-Info', 'FIL-INFO'],
        ['CLS-L1DROIT', 'L1-Droit', 'FIL-DROIT']
    ];
    classesSheet.getRange(2, 1, demoClasses.length, demoClasses[0].length).setValues(demoClasses);

    // 5. Ajouter des donn√©es de d√©monstration
    const planningSheet = ss.getSheetByName(SHEET_NAMES.PLANNING);
    const today = new Date();
    const tomorrow = new Date();
    tomorrow.setDate(today.getDate() + 1);
    const demoPlanning = [
      ['C001', 'L1-Info', 'Algorithmique', 'Prof. Ba', today, '08:00', '10:00', 'Confirm√©'],
      ['C002', 'L1-Droit', 'Introduction au Droit', 'Prof. Ndiaye', today, '10:00', '12:00', 'Confirm√©'],
      ['C003', 'L1-Info', 'Bases de donn√©es', 'Prof. Sow', tomorrow, '08:00', '10:00', 'En attente']
    ];
    planningSheet.getRange(2, 1, demoPlanning.length, demoPlanning[0].length).setValues(demoPlanning);
    planningSheet.getRange('E:E').setNumberFormat('dd/mm/yyyy');
    planningSheet.getRange('F:G').setNumberFormat('hh"h"mm');
    planningSheet.autoResizeColumns(1, planningSheet.getLastColumn());

    const studentsSheet = ss.getSheetByName(SHEET_NAMES.STUDENTS);
    const demoStudents = [
        ['ETU-DEMO1', 'Moussa Fall', 'FIL-INFO', 'CLS-L1INFO', 'm.fall@example.com', univId, new Date()],
        ['ETU-DEMO2', 'Awa Diop', 'FIL-DROIT', 'CLS-L1DROIT', 'a.diop@example.com', univId, new Date()]
    ];
    studentsSheet.getRange(2, 1, demoStudents.length, demoStudents[0].length).setValues(demoStudents);
    studentsSheet.getRange('F:F').setNumberFormat('dd/mm/yyyy hh:mm');
    studentsSheet.autoResizeColumns(1, studentsSheet.getLastColumn());

    // 6. Message final
    ui.alert(
      'üöÄ Configuration Termin√©e !',
      'Votre syst√®me ABM EduPilote est pr√™t.\n\nProchaines √©tapes :\n1. Allez dans l\'onglet "Administrateurs" pour voir le compte d√©mo (admin@demo.com / password).\n2. D√©ployez le script en tant qu\'application web si ce n\'est pas d√©j√† fait.\n3. Utilisez le menu "ABM Gestion U" pour commencer.',
      ui.ButtonSet.OK
    );

  } catch (e) {
    Logger.log(e);
    ui.alert('Erreur lors de la configuration', e.message, ui.ButtonSet.OK);
  }
}


/**
 * NOUVEAU : Cr√©e une r√©ponse standard au format JSON pour l'API.
 */
function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}


// --- TOUTES LES AUTRES FONCTIONS (onOpen, createDailyForms, processFormResponse, etc.) RESTENT IDENTIQUES ---
// (Le code complet est inclus ci-dessous pour √©viter toute confusion)

function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('ABM Gestion U')

    .addItem('1. Initialiser le Syst√®me (Setup)', 'setup')
    .addSeparator()
    .addItem('G√©n√©rer les URLs des QR Codes', 'generateQrCodeUrls')
    .addItem('G√©n√©rer les liens d\'inscription', 'generateRegistrationLinks')
    .addToUi();
}

function getConfiguration() {
  const configSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.CONFIG);
  if (!configSheet) return {};
  const data = configSheet.getDataRange().getValues();
  data.shift();
  const config = {};
  data.forEach(row => { if (row[0] && row[1]) { config[row[0]] = row[1]; } });
  return config;
}

function generateQrCodeUrls() {
  try {
    const htmlContent = generateQrCodeUrlsLogic();
    const htmlOutput = HtmlService.createHtmlOutput(htmlContent).setWidth(600).setHeight(500);
    SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'G√©n√©rateur d\'URLs pour QR Codes');
  } catch (error) {
    Logger.log(`Erreur generateQrCodeUrls: ${error.toString()}`);
    SpreadsheetApp.getUi().alert(`Erreur: ${error.message}`);
  }
}

/**
 * NOUVEAU : G√©n√®re des liens d'inscription sp√©cifiques √† chaque classe.
 */
function generateRegistrationLinks() {
  try {
    const htmlContent = generateRegistrationLinksLogic();
    const htmlOutput = HtmlService.createHtmlOutput(htmlContent).setWidth(600).setHeight(400);
    SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'G√©n√©rateur de Liens d\'Inscription');
  } catch (error) {
    Logger.log(`Erreur generateRegistrationLinks: ${error.toString()}`);
    SpreadsheetApp.getUi().alert(`Erreur: ${error.message}`);
  }
}

// ============================================================================
// FONCTIONS POUR L'INTERFACE ADMIN (appel√©es par doPost)
// ============================================================================

/**
 * NOUVEAU: Version de generateQrCodeUrls pour l'interface admin HTML.
 * Renvoie une r√©ponse JSON avec le contenu HTML.
 */
function generateQrCodeUrlsForAdmin(data) {
  try {
    const htmlContent = generateQrCodeUrlsLogic(data.universityId);
    return createJsonResponse({ success: true, html: htmlContent });
  } catch (error) {
    Logger.log(`Erreur generateQrCodeUrlsForAdmin: ${error.toString()}`);
    return createJsonResponse({ success: false, error: error.message });
  }
}

/**
 * NOUVEAU: Version de generateRegistrationLinks pour l'interface admin HTML.
 * Renvoie une r√©ponse JSON avec le contenu HTML.
 */
function generateRegistrationLinksForAdmin(data) {
  try {
    const htmlContent = generateRegistrationLinksLogic(data.universityId);
    return createJsonResponse({ success: true, html: htmlContent });
  } catch (error) {
    Logger.log(`Erreur generateRegistrationLinksForAdmin: ${error.toString()}`);
    return createJsonResponse({ success: false, error: error.message });
  }
}

// ============================================================================
// LOGIQUE M√âTIER REFACTORIS√âE (pour √™tre appel√©e par les deux interfaces)
// ============================================================================

/**
 * NOUVEAU: Logique de g√©n√©ration des QR codes, renvoie le HTML.
 */
function generateQrCodeUrlsLogic(universityId) {
  const config = getConfiguration();
  const frontendUrl = config.FRONTEND_URL;

  if (!frontendUrl || frontendUrl.includes('METTRE_URL')) {
    throw new Error("L'URL du frontend n'est pas configur√©e. Veuillez l'ajouter dans l'onglet Configuration.");
  }
  if (!universityId) {
    throw new Error("ID de l'universit√© manquant pour g√©n√©rer les liens.");
  }

  const filieresSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.FILIERES);
  const filieresData = filieresSheet.getDataRange().getValues();
  const filieresHeaders = filieresData.shift();
  const allowedFiliereIds = filieresData
      .filter(row => row[filieresHeaders.indexOf('ID_UNIVERSITE_FK')] === universityId)
      .map(row => row[filieresHeaders.indexOf('ID_FILIERE')]);

  const classesSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.CLASSES);
  const classesData = classesSheet.getDataRange().getValues();
  const classesHeaders = classesData.shift();
  const classes = classesData
      .filter(row => allowedFiliereIds.includes(row[classesHeaders.indexOf('ID_FILIERE_FK')]))
      .map(row => ({ id: row[classesHeaders.indexOf('ID_CLASSE')], name: row[classesHeaders.indexOf('NOM_CLASSE')] }));

  let htmlContent = '<h2>URLs pour les QR Codes des salles</h2><ul>';
  classes.forEach(classe => {
    const fullUrl = `${frontendUrl}?page=attendance&classe=${encodeURIComponent(classe.id)}`;
    const qrCodeApiUrl = `https://quickchart.io/qr?text=${encodeURIComponent(fullUrl)}&size=200`;
    htmlContent += `<li style="margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 15px;"><b>Salle : ${classe.name}</b><br><img src="${qrCodeApiUrl}" alt="QR Code pour ${classe.name}"><br><p>URL √† encoder :</p><input type="text" value="${fullUrl}" readonly style="width:95%;"></li>`;
  });
  htmlContent += '</ul>';
  return htmlContent;
}

function getSheetNameForEntity(entityType) {
  const map = { 'university': SHEET_NAMES.UNIVERSITIES, 'filiere': SHEET_NAMES.FILIERES, 'classe': SHEET_NAMES.CLASSES };
  const sheetName = map[entityType];
  if (!sheetName) throw new Error(`Type d'entit√© inconnu: ${entityType}`);
  return sheetName;
}
function createHtmlResponse(title, message) {
  const html = `
    <!DOCTYPE html><html><head><base target="_top"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f2f5; margin: 0; padding: 15px; } .card { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; max-width: 100%; } h1 { color: #d9534f; } p { color: #333; }</style></head><body><div class="card"><h1>${title}</h1><p>${message}</p></div></body></html>`;
  return HtmlService.createHtmlOutput(html).setTitle(title);
}

/**
 * NOUVEAU: Logique de g√©n√©ration des liens d'inscription, renvoie le HTML.
 */
function generateRegistrationLinksLogic(universityId) {
  const config = getConfiguration();
  const frontendUrl = config.FRONTEND_URL;

  if (!frontendUrl || frontendUrl.includes('METTRE_URL')) {
    throw new Error("L'URL du frontend n'est pas configur√©e. Veuillez l'ajouter dans l'onglet Configuration.");
  }
  if (!universityId) {
    throw new Error("ID de l'universit√© manquant pour g√©n√©rer les liens.");
  }

  const filieresSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.FILIERES);
  const filieresData = filieresSheet.getDataRange().getValues();
  const filieresHeaders = filieresData.shift();
  const allowedFiliereIds = filieresData
      .filter(row => row[filieresHeaders.indexOf('ID_UNIVERSITE_FK')] === universityId)
      .map(row => row[filieresHeaders.indexOf('ID_FILIERE')]);

  const classesSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.CLASSES);
  const classesData = classesSheet.getDataRange().getValues();
  const classesHeaders = classesData.shift();
  const classes = classesData
      .filter(row => allowedFiliereIds.includes(row[classesHeaders.indexOf('ID_FILIERE_FK')]))
      .map(row => ({ id: row[classesHeaders.indexOf('ID_CLASSE')], name: row[classesHeaders.indexOf('NOM_CLASSE')] }));

  let htmlContent = '<h2>Liens d\'inscription par classe (Pr√™ts √† partager !)</h2><p>Partagez le lien correspondant √† la classe pour que les √©tudiants soient automatiquement assign√©s.</p><ul>';
  classes.forEach(classe => {
    const registrationLink = `${frontendUrl}?page=register&university=${encodeURIComponent(universityId)}&classe=${encodeURIComponent(classe.id)}`;
    htmlContent += `<li style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;"><b>Classe : ${classe.name}</b><br><input type="text" value="${registrationLink}" readonly style="width:95%; margin-top: 5px;"></li>`;
  });

  htmlContent += '</ul>';
  return htmlContent;
}
    const entities = values.map(row => {
      const entity = {};
      headers.forEach((header, i) => {
        entity[header] = row[i];
      });
      return entity;
    });
    return createJsonResponse({ success: true, data: entities });
  } catch (error) {
    return createJsonResponse({ success: false, error: error.message });
  }
}

/**
 * NOUVEAU : Ajoute une nouvelle entit√©.
 */
function addEntity(data) {
  try {
    const { entityType, payload, universityId } = data; // On re√ßoit l'ID de l'universit√©
    if (!entityType || !payload || !payload.name) {
      return createJsonResponse({ success: false, error: 'Donn√©es invalides. Le nom est obligatoire.' });
    }
    const sheetName = getSheetNameForEntity(entityType);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
    if (!sheet) {
      return createJsonResponse({ success: false, error: `L'entit√© '${entityType}' est inconnue.` });
    }
    
    const newId = `${entityType.substring(0, 3).toUpperCase()}-${Utilities.getUuid().substring(0, 4).toUpperCase()}`;
    
    let rowData;
    if (entityType === 'university') {
        rowData = [newId, payload.name];
    } else if (entityType === 'filiere') {
        if (!universityId) return createJsonResponse({ success: false, error: 'ID Universit√© manquant pour lier la fili√®re.' });
        rowData = [newId, payload.name, universityId];
    } else if (entityType === 'classe') {
        if (!payload.filiereId) return createJsonResponse({ success: false, error: 'ID Fili√®re manquant.' });
        rowData = [newId, payload.name, payload.filiereId];
    } else {
        throw new Error('Type d\'entit√© non g√©r√© pour l\'ajout.');
    }
    sheet.appendRow(rowData);

    return createJsonResponse({ success: true, message: `"${payload.name}" a √©t√© ajout√© avec succ√®s.` });
  } catch (error) {
    return createJsonResponse({ success: false, error: error.message });
  }
}
/**
 * NOUVEAU : Enregistre la pr√©sence d'un √©tudiant depuis le formulaire HTML.
 */
function recordAttendance(data) {
  try {
    const { studentId, classe, matiere } = data;
    if (!studentId || !classe || !matiere) {
      return createJsonResponse({ success: false, error: 'Donn√©es de pr√©sence manquantes.' });
    }

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const scanSheet = ss.getSheetByName(SHEET_NAMES.SCAN);
    const studentsSheet = ss.getSheetByName(SHEET_NAMES.STUDENTS);

    // Trouver le nom de l'√©tudiant
    const studentsData = studentsSheet.getRange(2, 1, studentsSheet.getLastRow() - 1, 2).getValues(); // ID et Nom
    let studentName = 'Inconnu';
    for (const row of studentsData) {
      if (row[0].toString().trim().toUpperCase() === studentId.trim().toUpperCase()) {
        studentName = row[1];
        break;
      }
    }

    const timestamp = new Date();
    scanSheet.appendRow([timestamp, studentId, studentName, classe, matiere, Utilities.formatDate(timestamp, Session.getScriptTimeZone(), 'yyyy-MM-dd'), Utilities.formatDate(timestamp, Session.getScriptTimeZone(), 'HH:mm:ss'), 'Pr√©sent']);

    return createJsonResponse({ success: true, message: `Pr√©sence enregistr√©e avec succ√®s pour ${studentName} (${studentId}).` });
  } catch (error) {
    Logger.log(`Erreur recordAttendance: ${error.toString()}`);
    return createJsonResponse({ success: false, error: `Erreur interne lors de l'enregistrement: ${error.message}` });
  }
}

/**
 * NOUVEAU : Trouve le cours actuel pour une classe donn√©e.
 */
function getCurrentCourse(data) {
  try {
    const { classe } = data;
    if (!classe) {
      return createJsonResponse({ success: false, error: 'Param√®tre "classe" manquant.' });
    }

    const planningSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.PLANNING);
    if (!planningSheet) {
      return createJsonResponse({ success: false, error: 'Erreur Syst√®me: L\'onglet "Planning" est introuvable.' });
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const planningData = planningSheet.getDataRange().getValues();
    const headers = planningData.shift();
    
    const classeIdx = headers.indexOf('CLASSE');
    const matiereIdx = headers.indexOf('MATIERE');
    const dateIdx = headers.indexOf('DATE_COURS');
    const statutIdx = headers.indexOf('STATUT');

    if ([classeIdx, matiereIdx, dateIdx, statutIdx].includes(-1)) {
        return createJsonResponse({ success: false, error: 'Erreur de Configuration: Colonnes manquantes dans Planning.' });
    }

    for (const row of planningData) {
      const courseDate = new Date(row[dateIdx]);
      courseDate.setHours(0, 0, 0, 0);

      if (row[classeIdx] == classe && courseDate.getTime() === today.getTime() && row[statutIdx] === 'Confirm√©') {
        const courseFound = { classe: row[classeIdx], matiere: row[matiereIdx] };
        return createJsonResponse({ success: true, data: courseFound });
      }
    }

    return createJsonResponse({ success: false, error: `Aucun cours confirm√© pour la classe ${classe} aujourd'hui.` });

  } catch (error) {
    Logger.log(`Erreur getCurrentCourse: ${error.toString()}`);
    return createJsonResponse({ success: false, error: `Erreur interne: ${error.message}` });
  }
}
/**
 * NOUVEAU : V√©rifie la cl√© d'administration.
 */
function adminLogin(data) {
  try {
    const { adminKey } = data;
    if (!adminKey) {
      return createJsonResponse({ success: false, error: 'Cl√© d\'administration manquante.' });
    }
    const config = getConfiguration();
    if (config.ADMIN_KEY && config.ADMIN_KEY === adminKey) {
      return createJsonResponse({ success: true, message: 'Connexion r√©ussie.' });
    } else {
      return createJsonResponse({ success: false, error: 'Cl√© d\'administration incorrecte.' });
    }
  } catch (error) {
    return createJsonResponse({ success: false, error: `Erreur interne: ${error.message}` });
  }
}
// ============================================================================
// FONCTIONS D'INITIALISATION ET UTILITAIRES (Mises √† jour)
// ============================================================================

/**
 * Initialise la structure du Google Sheet (onglets, en-t√™tes).
 * MISE √Ä JOUR : Ajout de la colonne DATE_INSCRIPTION.
 */
function setup() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ui = SpreadsheetApp.getUi();

  const response = ui.alert(
    'Confirmation de la Configuration',
    'Cette action va configurer votre Google Sheet pour ABM EduPilote. TOUTES les donn√©es et onglets existants seront supprim√©s et remplac√©s. √ätes-vous s√ªr de vouloir continuer ?',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    ui.alert('Configuration annul√©e.');
    return;
  }

  try {
    // 1. Nettoyer le Google Sheet
    ss.getSheets().forEach(sheet => {
      if (ss.getSheets().length > 1) { ss.deleteSheet(sheet); }
    });
    ss.getSheets()[0].setName('TEMP').clear();

    // 2. D√©finir la structure compl√®te
    const sheetConfigs = {
      [SHEET_NAMES.CONFIG]: { headers: ['Cl√©', 'Valeur'], color: '#f4b400', validations: {} },
      [SHEET_NAMES.UNIVERSITIES]: { headers: ['ID_UNIVERSITE', 'NOM_UNIVERSITE'], color: '#a61c00', validations: {} },
      [SHEET_NAMES.FILIERES]: { headers: ['ID_FILIERE', 'NOM_FILIERE', 'ID_UNIVERSITE_FK'], color: '#a61c00', validations: {} },
      [SHEET_NAMES.CLASSES]: { headers: ['ID_CLASSE', 'NOM_CLASSE', 'ID_FILIERE_FK'], color: '#a61c00', validations: {} },
      [SHEET_NAMES.ADMINS]: { headers: ['ID_ADMIN', 'EMAIL_ADMIN', 'PASSWORD', 'ID_UNIVERSITE_FK'], color: '#a61c00', validations: {} },
      [SHEET_NAMES.STUDENTS]: { headers: ['ID_ETUDIANT', 'NOM_COMPLET', 'ID_FILIERE_FK', 'ID_CLASSE_FK', 'EMAIL', 'ID_UNIVERSITE_FK', 'DATE_INSCRIPTION'], color: '#4285f4', validations: {} },
      [SHEET_NAMES.PLANNING]: { headers: ['ID_COURS', 'CLASSE', 'MATIERE', 'ENSEIGNANT', 'DATE_COURS', 'HEURE_DEBUT', 'HEURE_FIN', 'STATUT'], color: '#0f9d58', validations: { 'STATUT': ['Confirm√©', 'Annul√©', 'En attente'] } },
      [SHEET_NAMES.SCAN]: { headers: ['TIMESTAMP', 'ID_ETUDIANT', 'NOM_ETUDIANT', 'CLASSE', 'MATIERE', 'DATE_SCAN', 'HEURE_SCAN', 'STATUT_PRESENCE'], color: '#db4437', validations: { 'STATUT_PRESENCE': ['Pr√©sent', 'Absent', 'En retard', 'Justifi√©'] } },
      [SHEET_NAMES.CONDUCT]: { headers: ['ID_INCIDENT', 'DATE', 'ID_ETUDIANT', 'NOM_ETUDIANT', 'CLASSE', 'DESCRIPTION_INCIDENT', 'MESURE_PRISE'], color: '#673ab7', validations: {} }
    };

    // 3. Cr√©er et formater les onglets
    Object.entries(sheetConfigs).forEach(([name, config]) => {
      const sheet = ss.insertSheet(name);
      sheet.setTabColor(config.color);
      const headerRange = sheet.getRange(1, 1, 1, config.headers.length);
      headerRange.setValues([config.headers]);
      headerRange.setBackground(config.color).setFontColor('#ffffff').setFontWeight('bold').setHorizontalAlignment('center');
      sheet.setFrozenRows(1);

      const headers = config.headers;
      for (const colName in config.validations) {
        const colIndex = headers.indexOf(colName);
        if (colIndex !== -1) {
          const rule = SpreadsheetApp.newDataValidation().requireValueInList(config.validations[colName]).setAllowInvalid(false).build();
          sheet.getRange(2, colIndex + 1, sheet.getMaxRows() - 1, 1).setDataValidation(rule);
        }
      }
      config.headers.forEach((header, i) => sheet.autoResizeColumn(i + 1));
    });

    ss.deleteSheet(ss.getSheetByName('TEMP'));

    // 4. Remplir l'onglet Configuration
    const configSheet = ss.getSheetByName(SHEET_NAMES.CONFIG);
    const configData = [
      [CONFIG_KEYS.ADMIN_EMAIL, 'METTRE_VOTRE_EMAIL_ICI'],
      [CONFIG_KEYS.FRONTEND_URL, 'https://abm-edupilote.netlify.app/'],
      [CONFIG_KEYS.ADMIN_KEY, `admin-${Utilities.getUuid().substring(0, 8)}`] // G√©n√®re une cl√© admin par d√©faut
    ];
    configSheet.getRange(2, 1, configData.length, 2).setValues(configData);
    configSheet.autoResizeColumns(1, 2);

    // 5. Ajouter des donn√©es de d√©monstration pour les entit√©s
    const univId = 'UNIV-DEMO';
    const adminId = 'ADM-DEMO';
    ss.getSheetByName(SHEET_NAMES.UNIVERSITIES).getRange(2, 1, 1, 2).setValues([[univId, 'Universit√© Virtuelle de Dakar']]);
    ss.getSheetByName(SHEET_NAMES.ADMINS).getRange(2, 1, 1, 4).setValues([[adminId, 'admin@demo.com', 'password', univId]]);
    
    const filieresSheet = ss.getSheetByName(SHEET_NAMES.FILIERES);
    const demoFilieres = [
        ['FIL-INFO', 'Informatique de Gestion', 'UNIV-DEMO'],
        ['FIL-DROIT', 'Droit des Affaires', 'UNIV-DEMO']
    ];
    filieresSheet.getRange(2, 1, demoFilieres.length, demoFilieres[0].length).setValues(demoFilieres);

    const classesSheet = ss.getSheetByName(SHEET_NAMES.CLASSES);
    const demoClasses = [
        ['CLS-L1INFO', 'L1-Info', 'FIL-INFO'],
        ['CLS-L1DROIT', 'L1-Droit', 'FIL-DROIT']
    ];
    classesSheet.getRange(2, 1, demoClasses.length, demoClasses[0].length).setValues(demoClasses);

    // 5. Ajouter des donn√©es de d√©monstration
    const planningSheet = ss.getSheetByName(SHEET_NAMES.PLANNING);
    const today = new Date();
    const tomorrow = new Date();
    tomorrow.setDate(today.getDate() + 1);
    const demoPlanning = [
      ['C001', 'L1-Info', 'Algorithmique', 'Prof. Ba', today, '08:00', '10:00', 'Confirm√©'],
      ['C002', 'L1-Droit', 'Introduction au Droit', 'Prof. Ndiaye', today, '10:00', '12:00', 'Confirm√©'],
      ['C003', 'L1-Info', 'Bases de donn√©es', 'Prof. Sow', tomorrow, '08:00', '10:00', 'En attente']
    ];
    planningSheet.getRange(2, 1, demoPlanning.length, demoPlanning[0].length).setValues(demoPlanning);
    planningSheet.getRange('E:E').setNumberFormat('dd/mm/yyyy');
    planningSheet.getRange('F:G').setNumberFormat('hh"h"mm');
    planningSheet.autoResizeColumns(1, planningSheet.getLastColumn());

    const studentsSheet = ss.getSheetByName(SHEET_NAMES.STUDENTS);
    const demoStudents = [
        ['ETU-DEMO1', 'Moussa Fall', 'FIL-INFO', 'CLS-L1INFO', 'm.fall@example.com', univId, new Date()],
        ['ETU-DEMO2', 'Awa Diop', 'FIL-DROIT', 'CLS-L1DROIT', 'a.diop@example.com', univId, new Date()]
    ];
    studentsSheet.getRange(2, 1, demoStudents.length, demoStudents[0].length).setValues(demoStudents);
    studentsSheet.getRange('F:F').setNumberFormat('dd/mm/yyyy hh:mm');
    studentsSheet.autoResizeColumns(1, studentsSheet.getLastColumn());

    // 6. Message final
    ui.alert(
      'üöÄ Configuration Termin√©e !',
      'Votre syst√®me ABM EduPilote est pr√™t.\n\nProchaines √©tapes :\n1. Allez dans l\'onglet "Administrateurs" pour voir le compte d√©mo (admin@demo.com / password).\n2. D√©ployez le script en tant qu\'application web si ce n\'est pas d√©j√† fait.\n3. Utilisez le menu "ABM Gestion U" pour commencer.',
      ui.ButtonSet.OK
    );

  } catch (e) {
    Logger.log(e);
    ui.alert('Erreur lors de la configuration', e.message, ui.ButtonSet.OK);
  }
}


/**
 * NOUVEAU : Cr√©e une r√©ponse standard au format JSON pour l'API.
 */
function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}


// --- TOUTES LES AUTRES FONCTIONS (onOpen, createDailyForms, processFormResponse, etc.) RESTENT IDENTIQUES ---
// (Le code complet est inclus ci-dessous pour √©viter toute confusion)

function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('ABM Gestion U')

    .addItem('1. Initialiser le Syst√®me (Setup)', 'setup')
    .addSeparator()
    .addItem('G√©n√©rer les URLs des QR Codes', 'generateQrCodeUrls')
    .addItem('G√©n√©rer les liens d\'inscription', 'generateRegistrationLinks')
    .addToUi();
}

function getConfiguration() {
  const configSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.CONFIG);
  if (!configSheet) return {};
  const data = configSheet.getDataRange().getValues();
  data.shift();
  const config = {};
  data.forEach(row => { if (row[0] && row[1]) { config[row[0]] = row[1]; } });
  return config;
}

function generateQrCodeUrls() {
  try {
    const htmlContent = generateQrCodeUrlsLogic();
    const htmlOutput = HtmlService.createHtmlOutput(htmlContent).setWidth(600).setHeight(500);
    SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'G√©n√©rateur d\'URLs pour QR Codes');
  } catch (error) {
    Logger.log(`Erreur generateQrCodeUrls: ${error.toString()}`);
    SpreadsheetApp.getUi().alert(`Erreur: ${error.message}`);
  }
}

/**
 * NOUVEAU : G√©n√®re des liens d'inscription sp√©cifiques √† chaque classe.
 */
function generateRegistrationLinks() {
  try {
    const htmlContent = generateRegistrationLinksLogic();
    const htmlOutput = HtmlService.createHtmlOutput(htmlContent).setWidth(600).setHeight(400);
    SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'G√©n√©rateur de Liens d\'Inscription');
  } catch (error) {
    Logger.log(`Erreur generateRegistrationLinks: ${error.toString()}`);
    SpreadsheetApp.getUi().alert(`Erreur: ${error.message}`);
  }
}

// ============================================================================
// FONCTIONS POUR L'INTERFACE ADMIN (appel√©es par doPost)
// ============================================================================

/**
 * NOUVEAU: Version de generateQrCodeUrls pour l'interface admin HTML.
 * Renvoie une r√©ponse JSON avec le contenu HTML.
 */
function generateQrCodeUrlsForAdmin() {
  try {
    const htmlContent = generateQrCodeUrlsLogic();
    return createJsonResponse({ success: true, html: htmlContent });
  } catch (error) {
    Logger.log(`Erreur generateQrCodeUrlsForAdmin: ${error.toString()}`);
    return createJsonResponse({ success: false, error: error.message });
  }
}

/**
 * NOUVEAU: Version de generateRegistrationLinks pour l'interface admin HTML.
 * Renvoie une r√©ponse JSON avec le contenu HTML.
 */
function generateRegistrationLinksForAdmin() {
  try {
    const htmlContent = generateRegistrationLinksLogic();
    return createJsonResponse({ success: true, html: htmlContent });
  } catch (error) {
    Logger.log(`Erreur generateRegistrationLinksForAdmin: ${error.toString()}`);
    return createJsonResponse({ success: false, error: error.message });
  }
}

// ============================================================================
// LOGIQUE M√âTIER REFACTORIS√âE (pour √™tre appel√©e par les deux interfaces)
// ============================================================================

/**
 * NOUVEAU: Logique de g√©n√©ration des QR codes, renvoie le HTML.
 */
function generateQrCodeUrlsLogic() {
  const webAppUrl = ScriptApp.getService().getUrl();
  if (!webAppUrl) { throw new Error('D√©ployez d\'abord le script en tant qu\'application web.'); }
  const planningSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.PLANNING);
  const data = planningSheet.getDataRange().getValues();
  const headers = data.shift();
  const classeIdx = headers.indexOf('CLASSE');
  if (classeIdx === -1) { throw new Error('Colonne "CLASSE" introuvable.'); }
  const classes = [...new Set(data.map(row => row[classeIdx]).filter(c => c))];
  let htmlContent = '<h2>URLs pour les QR Codes des salles</h2><ul>';
  classes.forEach(classe => {
    const targetUrl = `?classe=${encodeURIComponent(classe)}`;
    const fullUrl = `${webAppUrl}${targetUrl}`;
    const qrCodeApiUrl = `https://quickchart.io/qr?text=${encodeURIComponent(fullUrl)}&size=200`;
    htmlContent += `<li style="margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 15px;"><b>Salle : ${classe}</b><br><img src="${qrCodeApiUrl}" alt="QR Code pour ${classe}"><br><p>URL √† encoder :</p><input type="text" value="${fullUrl}" readonly style="width:95%;"></li>`;
  });
  htmlContent += '</ul>';
  return htmlContent;
}

function getSheetNameForEntity(entityType) {
  const map = { 'university': SHEET_NAMES.UNIVERSITIES, 'filiere': SHEET_NAMES.FILIERES, 'classe': SHEET_NAMES.CLASSES };
  const sheetName = map[entityType];
  if (!sheetName) throw new Error(`Type d'entit√© inconnu: ${entityType}`);
  return sheetName;
}
function createHtmlResponse(title, message) {
  const html = `
    <!DOCTYPE html><html><head><base target="_top"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f2f5; margin: 0; padding: 15px; } .card { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; max-width: 100%; } h1 { color: #d9534f; } p { color: #333; }</style></head><body><div class="card"><h1>${title}</h1><p>${message}</p></div></body></html>`;
  return HtmlService.createHtmlOutput(html).setTitle(title);
}

/**
 * NOUVEAU: Logique de g√©n√©ration des liens d'inscription, renvoie le HTML.
 */
function generateRegistrationLinksLogic() {
  const config = getConfiguration();
  const frontendUrl = config.FRONTEND_URL;

  if (!frontendUrl || frontendUrl.includes('METTRE_URL')) {
    throw new Error("L'URL du frontend n'est pas configur√©e. Veuillez l'ajouter dans l'onglet Configuration.");
  }

  const planningSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAMES.PLANNING);
  const data = planningSheet.getDataRange().getValues();
  const headers = data.shift();
  const classeIdx = headers.indexOf('CLASSE');
  if (classeIdx === -1) { throw new Error('La colonne "CLASSE" est introuvable dans l\'onglet Planning.'); }
  const classes = [...new Set(data.map(row => row[classeIdx]).filter(c => c))];
  let htmlContent = '<h2>Liens d\'inscription par classe (Pr√™ts √† partager !)</h2><p>Partagez le lien correspondant √† la classe pour que les √©tudiants soient automatiquement assign√©s.</p><ul>';
  classes.forEach(classe => {
    // L'URL pointe vers la page d'inscription sur le frontend
    const registrationLink = `${frontendUrl}?page=register&classe=${encodeURIComponent(classe)}`;
    htmlContent += `<li style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;"><b>Classe : ${classe}</b><br><input type="text" value="${registrationLink}" readonly style="width:95%; margin-top: 5px;"></li>`;
  });

  htmlContent += '</ul>';
  return htmlContent;
}
