<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Responsable - ABM EduPilote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Inter:wght@400;500&display=swap');
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="dashboard-container" class="max-w-6xl mx-auto">
        <header class="mb-10">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800" style="font-family: 'Poppins', sans-serif;">üë®‚Äçüè´ Espace Responsable</h1>
                    <p id="class-name-header" class="text-gray-600 mt-2 text-xl">Gestion de la classe : Chargement...</p>
                </div>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-all">D√©connexion</button>
            </div>
        </header>

        <div class="grid md:grid-cols-3 gap-8">
            <!-- Colonne 1: Actions -->
            <div class="md:col-span-1 space-y-8">
                <!-- Formulaire d'ajout de cours -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Planifier un Cours</h3>
                    <form id="add-course-form" class="space-y-4">
                        <div>
                            <label for="course-matiere" class="block text-sm font-medium text-gray-700">Mati√®re</label>
                            <input type="text" id="course-matiere" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="course-enseignant" class="block text-sm font-medium text-gray-700">Enseignant</label>
                            <input type="text" id="course-enseignant" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="course-date" class="block text-sm font-medium text-gray-700">Date du cours</label>
                            <input type="date" id="course-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="course-start-time" class="block text-sm font-medium text-gray-700">Heure D√©but</label>
                                <input type="time" id="course-start-time" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="course-end-time" class="block text-sm font-medium text-gray-700">Heure Fin</label>
                                <input type="time" id="course-end-time" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 sm:text-sm">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Ajouter au planning</button>
                    </form>
                </div>
                <!-- G√©n√©ration de lien -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Lien d'Inscription</h3>
                    <p class="text-sm text-gray-600 mb-4">Partagez ce lien pour que les √©tudiants s'inscrivent √† votre classe.</p>
                    <button onclick="generateRegLink()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">G√©n√©rer le lien</button>
                    <div id="reg-link-container" class="mt-4 hidden">
                        <input type="text" id="reg-link-input" readonly class="w-full bg-gray-100 px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
            </div>
            <!-- Colonne 2: Affichage du planning -->
            <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Planning de la Classe</h3>
                <div id="planning-table-container" class="max-h-[70vh] overflow-y-auto"><p>Chargement du planning...</p></div>
            </div>
        </div>
    </div>

    <!-- Modal et Spinner (copi√©s de admin.html pour la coh√©rence) -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900">R√©sultat</h3>
                <div id="modal-content" class="mt-2 px-7 py-3"></div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600">Fermer</button>
                </div>
            </div>
        </div>
    </div>
    <div id="spinner-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxu3AOPGmm9Sd5ulhSqOEdQWBZ0Y9rzf2BJ0OI3M2zmsTyXUtbkgvxWru6cuVbk_JowTA/exec';
        const RESPONSABLE_SESSION_KEY = 'abm_responsable_session';

        // --- AUTHENTIFICATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');

            if (tokenFromUrl) {
                sessionStorage.setItem(RESPONSABLE_SESSION_KEY, tokenFromUrl);
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            const sessionToken = sessionStorage.getItem(RESPONSABLE_SESSION_KEY);
            if (!sessionToken) {
                window.location.href = 'index.html'; 
            } else {
                loadDashboard();
            }
        });

        function logout() {
            sessionStorage.removeItem(RESPONSABLE_SESSION_KEY);
            window.location.href = 'index.html';
        }

        // --- LOGIQUE DU TABLEAU DE BORD ---
        async function loadDashboard() {
            showSpinner(true);
            try {
                const result = await callResponsableApi('responsableGetDashboardData');
                const { className, courses } = result.data;
                document.getElementById('class-name-header').textContent = `Gestion de la classe : ${className}`;
                renderPlanning(courses);
                setupAddCourseForm();
            } catch (error) {
                showModal('Erreur', `Impossible de charger le tableau de bord: ${error.message}`);
            } finally {
                showSpinner(false);
            }
        }

        function renderPlanning(courses) {
            const container = document.getElementById('planning-table-container');
            if (courses.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Aucun cours planifi√© pour cette classe.</p>';
                return;
            }

            // Cr√©ation de la timeline
            const timeline = document.createElement('div');
            timeline.className = 'space-y-6';
            timeline.innerHTML = courses.map(course => {
                const statusColor = course.STATUT === 'Confirm√©' ? 'bg-green-100 text-green-800' : (course.STATUT === 'Annul√©' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800');
                const statusIcon = course.STATUT === 'Confirm√©' ? '‚úÖ' : (course.STATUT === 'Annul√©' ? '‚ùå' : '‚è≥');
                return `
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-800">${course.MATIERE}</p>
                                <p class="text-sm text-gray-500">${new Date(course.DATE_COURS).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                <p class="text-sm text-gray-500">${new Date(course.HEURE_DEBUT).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${new Date(course.HEURE_FIN).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                            </div>
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">${statusIcon} ${course.STATUT}</span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 text-sm space-x-4">
                            ${course.STATUT !== 'Confirm√©' ? `<button onclick="updateStatus('${course.ID_COURS}', 'Confirm√©')" class="font-medium text-green-600 hover:text-green-900">Confirmer</button>` : ''}
                            ${course.STATUT !== 'Annul√©' ? `<button onclick="updateStatus('${course.ID_COURS}', 'Annul√©')" class="font-medium text-red-600 hover:text-red-900">Annuler</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = '';
            container.appendChild(timeline);
        }

        function setupAddCourseForm() {
            const form = document.getElementById('add-course-form');
            // Remplacer addEventListener par onsubmit pour √©viter les listeners multiples
            form.onsubmit = async (e) => {
                e.preventDefault();
                const payload = {
                    matiere: document.getElementById('course-matiere').value,
                    enseignant: document.getElementById('course-enseignant').value,
                    date: document.getElementById('course-date').value,
                    startTime: document.getElementById('course-start-time').value,
                    endTime: document.getElementById('course-end-time').value,
                };
                showSpinner(true);
                try {
                    e.submitter.disabled = true;
                    const result = await callResponsableApi('responsableAddCourse', { payload });
                    showModal('Succ√®s', result.message);
                    form.reset();
                    loadDashboard();
                } catch (error) {
                    showModal('Erreur', error.message);
                } finally {
                    showSpinner(false);
                    if (e.submitter) e.submitter.disabled = false;
                }
            };
        }

        async function updateStatus(courseId, status) {
            if (!confirm(`Voulez-vous vraiment ${status.toLowerCase()} ce cours ?`)) return;
            showSpinner(true);
            try {
                const result = await callResponsableApi('responsableUpdateCourseStatus', { courseId, status });
                showModal('Succ√®s', result.message);
                loadDashboard();
            } catch (error) {
                showModal('Erreur', error.message);
            } finally {
                showSpinner(false);
            }
        }

        async function generateRegLink() {
            showSpinner(true);
            try {
                const result = await callResponsableApi('responsableGetRegLink');
                const container = document.getElementById('reg-link-container');
                const input = document.getElementById('reg-link-input');
                input.value = result.data.url;
                container.classList.remove('hidden');
                input.select();
                document.execCommand('copy');
                showModal('Succ√®s', 'Le lien d\'inscription a √©t√© copi√© dans votre presse-papiers.');
            } catch (error) {
                showModal('Erreur', error.message);
            } finally {
                showSpinner(false);
            }
        }

        // --- FONCTIONS UTILITAIRES ---
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal');
        const spinnerOverlay = document.getElementById('spinner-overlay');

        closeModalBtn.onclick = () => modal.classList.add('hidden');
        window.onclick = (event) => {
            if (event.target == modal) modal.classList.add('hidden');
        }

        function showSpinner(show) {
            spinnerOverlay.classList.toggle('hidden', !show);
        }

        function showModal(title, content) {
            modalTitle.textContent = title;
            modalContent.innerHTML = `<p>${content}</p>`;
            modal.classList.remove('hidden');
        }

        async function callResponsableApi(action, data = {}) {
            const responsableId = sessionStorage.getItem(RESPONSABLE_SESSION_KEY);
            if (!responsableId) {
                throw new Error('Session responsable invalide. Veuillez vous reconnecter.');
            }
            
            const response = await fetch(WEB_APP_URL, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action, data: { ...data, responsableId } })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Erreur API inconnue.');
            return result;
        }
    </script>

</body>
</html>
